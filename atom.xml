<?xml version="1.0" encoding="utf-8"?>
<feed xmlns="http://www.w3.org/2005/Atom">

  <title><![CDATA[The Dev Files]]></title>
  <link href="http://www.thedevfiles.com/atom.xml" rel="self"/>
  <link href="http://www.thedevfiles.com/"/>
  <updated>2014-08-21T22:23:15-07:00</updated>
  <id>http://www.thedevfiles.com/</id>
  <author>
    <name><![CDATA[Jonathan Bernardi]]></name>
    
  </author>
  <generator uri="http://octopress.org/">Octopress</generator>

  
  <entry>
    <title type="html"><![CDATA[Secure Password Hashing with PHP]]></title>
    <link href="http://www.thedevfiles.com/2014/08/secure-password-hashing/"/>
    <updated>2014-08-22T00:00:00-07:00</updated>
    <id>http://www.thedevfiles.com/2014/08/secure-password-hashing</id>
    <content type="html"><![CDATA[<p>There is a lot of misinformation and uncertainty on the topic of password storage.</p>

<p>There are massive amounts of tutorials and articles recommending all manor of methods of storing passwords.
A large number of these are old and using methods that just are up to snuff for todays security standards.</p>

<!--more-->


<h2>Common password storing mistakes</h2>

<p>Here are some of the most common mistakes make with regards to password hashing.</p>

<p>I&rsquo;ve been guilty of all of these in the past.</p>

<h3>MD5 and SHA1 hashing</h3>

<p>The <a href="http://us1.php.net/manual/en/function.md5.php">md5</a> and <a href="http://us1.php.net/manual/en/function.sha1.php">sha1</a> are not suitable for password hashing.</p>

<p>This is true for any of the related hashing algorithms from the <a href="http://us1.php.net/manual/en/function.hash.php">hash</a> function like sha256, sha512, and so on.
While the larger hashes are slightly better than the shorter ones they all suffer from the same problem.</p>

<p>Over time computers are getting faster and faster and can calculate a hash in a shorter amount of time.
A high end machine with a cluster of GPUs can calculate billions of md5 hashes a second.
You can rent such a machine from <a href="http://aws.amazon.com/ec2/pricing/">Amazon</a> for less than $1 an hour.</p>

<p>Over time each of these hashing functions will become faster and faster to break.</p>

<p>The other weakness of these algorithms is that unless the passwords are also salted they are susceptible to rainbow table attacks.</p>

<p>Every time a password is hashed it will result in the same hash.
This means if you have a list of hashes and their corresponding passwords you can just find the hash in the list to break the password.</p>

<h3>Trying to create your own hashing algorithm</h3>

<p>People have tried to get around the fast hashing algorithms by running them multiple times or trying to mix and match them to create their own hashing algorithm.</p>

<p>The problem is that the hashes can be calculated so fast that it would take thousands of hashes to make a difference.
Even then at time moves on computers will get even faster and the number of necessary hashes will just keep increasing.</p>

<h3>Using the same salt for all passwords</h3>

<p>Using the same salt for all passwords is much better then not using a salt at all.</p>

<p>Every password should have its own salt.</p>

<h2>The Solution</h2>

<p>So how should passwords be hashed?</p>

<ol>
<li>Each password needs to be salted with a different cryptographic salt.</li>
<li>The hashing algorithm must not be fast regardless of the power of the machine used to generate them.</li>
</ol>


<p>The current recommended methods for securely hashing passwords are <a href="http://en.wikipedia.org/wiki/Bcrypt">Bcrypt</a> or <a href="http://en.wikipedia.org/wiki/PBKDF2">PBKDF2</a>.</p>

<p>The Bcrypt algorithm can be used with the <a href="http://us1.php.net/manual/en/function.crypt.php">crypt</a> function but this isn&rsquo;t very easy to use.
You still need to generate a cryptographic salt and that isn&rsquo;t very easy either.</p>

<p>Thankfully there is now a better way.</p>

<p>PHP 5.5 added the <a href="http://php.net/manual/en/function.password-hash.php">password_hash</a> function which hides the ugliness of using the crypt function and makes secure password hashing truly easy.</p>

<p>Not using PHP 5.5+?  The <a href="https://github.com/ircmaxell/password_compat">ircmaxell/password_compat</a> library will add the same functionality to PHP 5.3.7+.</p>

<p>Even better? The password_hash function is future proof.  While Bcrypt is the best algorithm available to PHP for hashing passwords this may not always be the case.
As better algorithms are released the password_hash function will automatically use the best algorithm available.</p>

<p>Your application will begin to use the newer more secure algorithm without you even touching the code.</p>

<h2>Using password_hash for password hashing</h2>

<p>For this example I&rsquo;m assuming you have a database table called users with a username and a password column.</p>

<p>I&rsquo;m also using PDO for the database interactions.
If you need help using PDO take a look at the article I wrote about <a href="http://www.thedevfiles.com/2014/08/moving-from-mysql-query-to-pdo/">Migrating from mysql_query to PDO</a>.
Make sure to use prepared statements to prevent SQL injection.</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
<span class='line-number'>34</span>
<span class='line-number'>35</span>
<span class='line-number'>36</span>
<span class='line-number'>37</span>
<span class='line-number'>38</span>
<span class='line-number'>39</span>
<span class='line-number'>40</span>
<span class='line-number'>41</span>
<span class='line-number'>42</span>
<span class='line-number'>43</span>
<span class='line-number'>44</span>
<span class='line-number'>45</span>
<span class='line-number'>46</span>
<span class='line-number'>47</span>
<span class='line-number'>48</span>
<span class='line-number'>49</span>
<span class='line-number'>50</span>
<span class='line-number'>51</span>
<span class='line-number'>52</span>
<span class='line-number'>53</span>
<span class='line-number'>54</span>
<span class='line-number'>55</span>
<span class='line-number'>56</span>
<span class='line-number'>57</span>
<span class='line-number'>58</span>
<span class='line-number'>59</span>
<span class='line-number'>60</span>
<span class='line-number'>61</span>
<span class='line-number'>62</span>
<span class='line-number'>63</span>
<span class='line-number'>64</span>
<span class='line-number'>65</span>
<span class='line-number'>66</span>
<span class='line-number'>67</span>
<span class='line-number'>68</span>
<span class='line-number'>69</span>
<span class='line-number'>70</span>
<span class='line-number'>71</span>
<span class='line-number'>72</span>
<span class='line-number'>73</span>
<span class='line-number'>74</span>
<span class='line-number'>75</span>
<span class='line-number'>76</span>
<span class='line-number'>77</span>
<span class='line-number'>78</span>
</pre></td><td class='code'><pre><code class='php'><span class='line'><span class="o">&lt;?</span><span class="nx">php</span>
</span><span class='line'>
</span><span class='line'><span class="k">class</span> <span class="nc">UserModel</span>
</span><span class='line'><span class="p">{</span>
</span><span class='line'>
</span><span class='line'>    <span class="sd">/**</span>
</span><span class='line'><span class="sd">     * @var PDO</span>
</span><span class='line'><span class="sd">     */</span>
</span><span class='line'>    <span class="k">protected</span> <span class="nv">$dbh</span><span class="p">;</span>
</span><span class='line'>
</span><span class='line'>    <span class="sd">/**</span>
</span><span class='line'><span class="sd">     * @param PDO $dbh</span>
</span><span class='line'><span class="sd">     */</span>
</span><span class='line'>    <span class="k">public</span> <span class="k">function</span> <span class="nf">__construct</span><span class="p">(</span><span class="nx">PDO</span> <span class="nv">$dbh</span><span class="p">)</span>
</span><span class='line'>    <span class="p">{</span>
</span><span class='line'>        <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">dbh</span> <span class="o">=</span> <span class="nv">$dbh</span><span class="p">;</span>
</span><span class='line'>    <span class="p">}</span>
</span><span class='line'>
</span><span class='line'>    <span class="sd">/**</span>
</span><span class='line'><span class="sd">     * Checks account credentials</span>
</span><span class='line'><span class="sd">     *</span>
</span><span class='line'><span class="sd">     * @param string $username</span>
</span><span class='line'><span class="sd">     * @param string $password</span>
</span><span class='line'><span class="sd">     *</span>
</span><span class='line'><span class="sd">     * @return array|false Array of user data if credentials are correct or boolean false if credentials are not correct</span>
</span><span class='line'><span class="sd">     */</span>
</span><span class='line'>    <span class="k">public</span> <span class="k">function</span> <span class="nf">checkCredentials</span><span class="p">(</span><span class="nv">$username</span><span class="p">,</span> <span class="nv">$password</span><span class="p">)</span>
</span><span class='line'>    <span class="p">{</span>
</span><span class='line'>        <span class="nv">$user</span> <span class="o">=</span> <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">getUserByUsername</span><span class="p">(</span><span class="nv">$username</span><span class="p">);</span>
</span><span class='line'>        <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nv">$user</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>            <span class="c1">// No user found with provided username</span>
</span><span class='line'>            <span class="k">return</span> <span class="k">false</span><span class="p">;</span>
</span><span class='line'>        <span class="p">}</span>
</span><span class='line'>        <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nx">password_verify</span><span class="p">(</span><span class="nv">$password</span><span class="p">,</span> <span class="nv">$user</span><span class="p">[</span><span class="s1">&#39;password&#39;</span><span class="p">]))</span> <span class="p">{</span>
</span><span class='line'>            <span class="c1">// Password does not match</span>
</span><span class='line'>            <span class="k">return</span> <span class="k">false</span><span class="p">;</span>
</span><span class='line'>        <span class="p">}</span>
</span><span class='line'>        <span class="k">if</span> <span class="p">(</span><span class="nx">password_needs_rehash</span><span class="p">(</span><span class="nv">$user</span><span class="p">[</span><span class="s1">&#39;password&#39;</span><span class="p">],</span> <span class="nx">PASSWORD_DEFAULT</span><span class="p">))</span> <span class="p">{</span>
</span><span class='line'>            <span class="c1">// This password was hashed using an older algorithm, update with new hash.</span>
</span><span class='line'>            <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">updatePassword</span><span class="p">(</span><span class="nv">$user</span><span class="p">[</span><span class="s1">&#39;id&#39;</span><span class="p">],</span> <span class="nv">$password</span><span class="p">);</span>
</span><span class='line'>        <span class="p">}</span>
</span><span class='line'>        <span class="c1">// The password is no longer needed from the user data</span>
</span><span class='line'>        <span class="nb">unset</span><span class="p">(</span><span class="nv">$user</span><span class="p">[</span><span class="s1">&#39;password&#39;</span><span class="p">]);</span>
</span><span class='line'>        <span class="k">return</span> <span class="nv">$user</span><span class="p">;</span>
</span><span class='line'>    <span class="p">}</span>
</span><span class='line'>
</span><span class='line'>    <span class="sd">/**</span>
</span><span class='line'><span class="sd">     * Returns a user by username</span>
</span><span class='line'><span class="sd">     *</span>
</span><span class='line'><span class="sd">     * @param string $username</span>
</span><span class='line'><span class="sd">     *</span>
</span><span class='line'><span class="sd">     * @return array|false Array of user data if found or boolean false if not found</span>
</span><span class='line'><span class="sd">     */</span>
</span><span class='line'>    <span class="k">public</span> <span class="k">function</span> <span class="nf">getUserByUsername</span><span class="p">(</span><span class="nv">$username</span><span class="p">)</span>
</span><span class='line'>    <span class="p">{</span>
</span><span class='line'>        <span class="nv">$sth</span> <span class="o">=</span> <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">dbh</span><span class="o">-&gt;</span><span class="na">prepare</span><span class="p">(</span><span class="s2">&quot;SELECT * FROM users WHERE username LIKE :username&quot;</span><span class="p">);</span>
</span><span class='line'>        <span class="nv">$sth</span><span class="o">-&gt;</span><span class="na">bindValue</span><span class="p">(</span><span class="s2">&quot;:username&quot;</span><span class="p">,</span> <span class="nv">$username</span><span class="p">);</span>
</span><span class='line'>        <span class="nv">$sth</span><span class="o">-&gt;</span><span class="na">execute</span><span class="p">();</span>
</span><span class='line'>        <span class="k">return</span> <span class="nv">$sth</span><span class="o">-&gt;</span><span class="na">fetch</span><span class="p">(</span><span class="nx">PDO</span><span class="o">::</span><span class="na">FETCH_ASSOC</span><span class="p">);</span>
</span><span class='line'>    <span class="p">}</span>
</span><span class='line'>
</span><span class='line'>    <span class="sd">/**</span>
</span><span class='line'><span class="sd">     * Updates a user&#39;s password</span>
</span><span class='line'><span class="sd">     *</span>
</span><span class='line'><span class="sd">     * @param int $id</span>
</span><span class='line'><span class="sd">     * @param string $password</span>
</span><span class='line'><span class="sd">     *</span>
</span><span class='line'><span class="sd">     * @return int Number of affected rows</span>
</span><span class='line'><span class="sd">     */</span>
</span><span class='line'>    <span class="k">public</span> <span class="k">function</span> <span class="nf">updatePassword</span><span class="p">(</span><span class="nv">$id</span><span class="p">,</span> <span class="nv">$password</span><span class="p">)</span>
</span><span class='line'>    <span class="p">{</span>
</span><span class='line'>        <span class="nv">$hash</span> <span class="o">=</span> <span class="nx">password_hash</span><span class="p">(</span><span class="nv">$password</span><span class="p">,</span> <span class="nx">PASSWORD_DEFAULT</span><span class="p">);</span>
</span><span class='line'>        <span class="nv">$sth</span> <span class="o">=</span> <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">dbh</span><span class="o">-&gt;</span><span class="na">prepare</span><span class="p">(</span><span class="s2">&quot;UPDATE users SET password = :password WHERE id = :id&quot;</span><span class="p">);</span>
</span><span class='line'>        <span class="nv">$sth</span><span class="o">-&gt;</span><span class="na">bindValue</span><span class="p">(</span><span class="s2">&quot;:password&quot;</span><span class="p">,</span> <span class="nv">$hash</span><span class="p">);</span>
</span><span class='line'>        <span class="nv">$sth</span><span class="o">-&gt;</span><span class="na">bindValue</span><span class="p">(</span><span class="s2">&quot;:id&quot;</span><span class="p">,</span> <span class="nv">$id</span><span class="p">,</span> <span class="nx">PDO</span><span class="o">::</span><span class="na">PARAM_INT</span><span class="p">);</span>
</span><span class='line'>        <span class="k">return</span> <span class="nv">$sth</span><span class="o">-&gt;</span><span class="na">execute</span><span class="p">();</span>
</span><span class='line'>    <span class="p">}</span>
</span><span class='line'><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<h3>How it works</h3>

<ol>
<li>You pass the username and password the user provided in the login form to the checkCredentials method.</li>
<li>This method searches the database for a user with a matching username.</li>
<li>If no user is found the provided username was incorrect.</li>
<li>Next the <a href="http://php.net/manual/en/function.password-verify.php">password_verify</a> is called to check if the password was used to generate the hash that was stored in the database for the user with the matching username.</li>
<li>If it returns false then the provided password was incorrect.</li>
<li>Now that we have confirmed the provided login credentials are correct we pass the hashed password from the database to <a href="http://php.net/manual/en/function.password-needs-rehash.php">password_needs_rehash</a>.  This checks if the password needs to be upgraded to a newer, stronger algorithm.</li>
<li>If it returns true update the user&rsquo;s password by passing the provided password to the <a href="http://php.net/manual/en/function.password-hash.php">password_hash</a> function.</li>
<li>Return the user account so you can log the user in.</li>
</ol>

]]></content>
  </entry>
  
  <entry>
    <title type="html"><![CDATA[Simplifying database interactions with Doctrine DBAL]]></title>
    <link href="http://www.thedevfiles.com/2014/08/simplifying-database-interactions-with-doctrine-dbal/"/>
    <updated>2014-08-15T00:00:00-07:00</updated>
    <id>http://www.thedevfiles.com/2014/08/simplifying-database-interactions-with-doctrine-dbal</id>
    <content type="html"><![CDATA[<p>I previously wrote about <a href="http://www.thedevfiles.com/2014/08/moving-from-mysql-query-to-pdo">switching from the mysql extension to PDO</a>.
PDO introduces a number of convenient features beyond the mysql extension such as transactions, prepared statements, and more fetching options.
However there are still a few things that are a bit painful.</p>

<p>This article will introduce <a href="http://www.doctrine-project.org/projects/dbal.html">Doctrine DBAL</a> to help alleviate some of these pain points.</p>

<p><abbr title="Doctrine database abstraction &amp; access layer">Doctrine DBAL</abbr> is a wrapper around <a href="http://php.net/manual/en/book.pdo.php">PDO</a>.
It adds a few conveniences beyond straight PDO as well as a query builder.</p>

<!--more-->


<p>There are a <a href="http://www.doctrine-project.org/projects.html">number of projects</a> under the Doctrine umbrella including a full <abbr title="Object Relational Mapper">ORM</abbr>.
This article will only cover the DBAL project.</p>

<h2>Installing Doctrine DBAL</h2>

<p>The recommended way to install Doctrine DBAL is via <a href="https://getcomposer.org/">composer</a>.</p>

<figure class='code'><figcaption><span>Add to the composer.json require section</span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='json'><span class='line'><span class="s2">&quot;doctrine/dbal&quot;</span><span class="err">:</span> <span class="s2">&quot;2.3.4&quot;</span>
</span></code></pre></td></tr></table></div></figure>


<p>Alternatively you can download a zip archive from the <a href="http://www.doctrine-project.org/projects/dbal.html">project page</a>.</p>

<p>If you aren&rsquo;t using composer or don&rsquo;t have a PSR-0 compatible autoloader you will need to add the class loader in the Doctrine/Common folder to load the Doctrine DBAL classes.</p>

<figure class='code'><figcaption><span>Setup Class Loader</span><a href='http://docs.doctrine-project.org/projects/doctrine-dbal/en/latest/reference/introduction.html'>link</a></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
</pre></td><td class='code'><pre><code class='php'><span class='line'><span class="k">use</span> <span class="nx">Doctrine\Common\ClassLoader</span><span class="p">;</span>
</span><span class='line'>
</span><span class='line'><span class="k">require</span> <span class="s1">&#39;/path/to/doctrine/lib/Doctrine/Common/ClassLoader.php&#39;</span><span class="p">;</span>
</span><span class='line'>
</span><span class='line'><span class="nv">$classLoader</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">ClassLoader</span><span class="p">(</span><span class="s1">&#39;Doctrine&#39;</span><span class="p">,</span> <span class="s1">&#39;/path/to/doctrine&#39;</span><span class="p">);</span>
</span><span class='line'><span class="nv">$classLoader</span><span class="o">-&gt;</span><span class="na">register</span><span class="p">();</span>
</span></code></pre></td></tr></table></div></figure>


<h2>Connecting to The Database</h2>

<p>Doctrine DBAL can connect to any type of database that PDO can connect to.
For this article I am going to assume you are connecting to MySQL but the api is the same regardless of the database you are connecting to.</p>

<figure class='code'><figcaption><span>Connecting to the database</span><a href='http://docs.doctrine-project.org/projects/doctrine-dbal/en/latest/reference/configuration.html#'>link</a></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
</pre></td><td class='code'><pre><code class='php'><span class='line'><span class="nv">$config</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">\Doctrine\DBAL\Configuration</span><span class="p">();</span>
</span><span class='line'>
</span><span class='line'><span class="nv">$connectionParams</span> <span class="o">=</span> <span class="k">array</span><span class="p">(</span>
</span><span class='line'>    <span class="s1">&#39;dbname&#39;</span> <span class="o">=&gt;</span> <span class="s1">&#39;database&#39;</span><span class="p">,</span>
</span><span class='line'>    <span class="s1">&#39;user&#39;</span> <span class="o">=&gt;</span> <span class="s1">&#39;user&#39;</span><span class="p">,</span>
</span><span class='line'>    <span class="s1">&#39;password&#39;</span> <span class="o">=&gt;</span> <span class="s1">&#39;password&#39;</span><span class="p">,</span>
</span><span class='line'>    <span class="s1">&#39;host&#39;</span> <span class="o">=&gt;</span> <span class="s1">&#39;localhost&#39;</span><span class="p">,</span>
</span><span class='line'>    <span class="s1">&#39;port&#39;</span> <span class="o">=&gt;</span> <span class="mi">3306</span><span class="p">,</span>
</span><span class='line'>    <span class="s1">&#39;charset&#39;</span> <span class="o">=&gt;</span> <span class="s1">&#39;utf8&#39;</span><span class="p">,</span>
</span><span class='line'>    <span class="s1">&#39;driver&#39;</span> <span class="o">=&gt;</span> <span class="s1">&#39;pdo_mysql&#39;</span><span class="p">,</span>
</span><span class='line'><span class="p">);</span>
</span><span class='line'><span class="nv">$dbh</span> <span class="o">=</span> <span class="nx">\Doctrine\DBAL\DriverManager</span><span class="o">::</span><span class="na">getConnection</span><span class="p">(</span><span class="nv">$connectionParams</span><span class="p">,</span> <span class="nv">$config</span><span class="p">);</span>
</span></code></pre></td></tr></table></div></figure>


<p>One advantage that Doctrine DBAL has over plain PDO is that the Doctrine connection doesn&rsquo;t actually connect to the database until the first query is run.
This means you can create the connection in the bootstrap of your application and if no queries are run for a particular request it wont need to actually connect to the database server.
PDO connects to the database server as soon as you create a PDO instance.</p>

<h2>Running Queries</h2>

<p>Being a wrapper around PDO you can use the full PDO api including prepared statements and transactions just like you would with straight PDO.</p>

<p>Fetching Data works exactly the same as with straight PDO.</p>

<figure class='code'><figcaption><span>Fetching Data</span><a href='http://docs.doctrine-project.org/projects/doctrine-dbal/en/latest/reference/data-retrieval-and-manipulation.html#fetchall'>link</a></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
</pre></td><td class='code'><pre><code class='php'><span class='line'><span class="c1">// Fetch one row</span>
</span><span class='line'><span class="nv">$sth</span> <span class="o">=</span> <span class="nv">$dbh</span><span class="o">-&gt;</span><span class="na">query</span><span class="p">(</span><span class="s2">&quot;SELECT * FROM users WHERE id = 1&quot;</span><span class="p">);</span>
</span><span class='line'><span class="nv">$user</span> <span class="o">=</span> <span class="nv">$sth</span><span class="o">-&gt;</span><span class="na">fetch</span><span class="p">();</span>
</span><span class='line'>
</span><span class='line'><span class="c1">// Fetch all rows</span>
</span><span class='line'><span class="nv">$sth</span> <span class="o">=</span> <span class="nv">$dbh</span><span class="o">-&gt;</span><span class="na">query</span><span class="p">(</span><span class="s2">&quot;SELECT * FROM users&quot;</span><span class="p">);</span>
</span><span class='line'><span class="nv">$users</span> <span class="o">=</span> <span class="nv">$sth</span><span class="o">-&gt;</span><span class="na">fetchAll</span><span class="p">();</span>
</span><span class='line'>
</span><span class='line'><span class="c1">// Fetch column as scalar value</span>
</span><span class='line'><span class="nv">$sth</span> <span class="o">=</span> <span class="nv">$dbh</span><span class="o">-&gt;</span><span class="na">query</span><span class="p">(</span><span class="s2">&quot;SELECT email FROM users WHERE id = 1&quot;</span><span class="p">);</span>
</span><span class='line'><span class="nv">$email</span> <span class="o">=</span> <span class="nv">$sth</span><span class="o">-&gt;</span><span class="na">fetchColumn</span><span class="p">();</span>
</span><span class='line'>
</span><span class='line'><span class="c1">// Fetch column as array of scalar values</span>
</span><span class='line'><span class="nv">$sth</span> <span class="o">=</span> <span class="nv">$dbh</span><span class="o">-&gt;</span><span class="na">query</span><span class="p">(</span><span class="s2">&quot;SELECT email FROM users&quot;</span><span class="p">);</span>
</span><span class='line'><span class="nv">$emails</span> <span class="o">=</span> <span class="nv">$sth</span><span class="o">-&gt;</span><span class="na">fetchAll</span><span class="p">(</span><span class="nx">PDO</span><span class="o">::</span><span class="na">FETCH_COLUMN</span><span class="p">);</span>
</span><span class='line'>
</span><span class='line'><span class="c1">// Fetch column as key value pairs</span>
</span><span class='line'><span class="nv">$sth</span> <span class="o">=</span> <span class="nv">$dbh</span><span class="o">-&gt;</span><span class="na">query</span><span class="p">(</span><span class="s2">&quot;SELECT id, email FROM users&quot;</span><span class="p">);</span>
</span><span class='line'><span class="nv">$users</span> <span class="o">=</span> <span class="nv">$sth</span><span class="o">-&gt;</span><span class="na">fetchAll</span><span class="p">(</span><span class="nx">PDO</span><span class="o">::</span><span class="na">FETCH_KEY_PAIR</span><span class="p">);</span>
</span></code></pre></td></tr></table></div></figure>


<p>Prepared statements are also the same as straight PDO.</p>

<figure class='code'><figcaption><span>Prepared Statements</span><a href='http://docs.doctrine-project.org/projects/doctrine-dbal/en/latest/reference/data-retrieval-and-manipulation.html#using-prepared-statements'>link</a></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
</pre></td><td class='code'><pre><code class='php'><span class='line'><span class="nv">$sth</span> <span class="o">=</span> <span class="nv">$dbh</span><span class="o">-&gt;</span><span class="na">prepare</span><span class="p">(</span><span class="s2">&quot;SELECT * FROM users WHERE id = ?&quot;</span><span class="p">);</span>
</span><span class='line'><span class="nv">$sth</span><span class="o">-&gt;</span><span class="na">bindValue</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="nv">$id</span><span class="p">,</span> <span class="nx">PDO</span><span class="o">::</span><span class="na">PARAM_INT</span><span class="p">);</span>
</span><span class='line'><span class="nv">$sth</span><span class="o">-&gt;</span><span class="na">execute</span><span class="p">();</span>
</span><span class='line'><span class="nv">$user</span> <span class="o">=</span> <span class="nv">$sth</span><span class="o">-&gt;</span><span class="na">fetchAssoc</span><span class="p">();</span>
</span><span class='line'>
</span><span class='line'><span class="nv">$sth</span> <span class="o">=</span> <span class="nv">$dbh</span><span class="o">-&gt;</span><span class="na">prepare</span><span class="p">(</span><span class="s2">&quot;UPDATE users SET name = :name, email = :email WHERE id = :id&quot;</span><span class="p">);</span>
</span><span class='line'><span class="nv">$sth</span><span class="o">-&gt;</span><span class="na">bindeValue</span><span class="p">(</span><span class="s2">&quot;:name&quot;</span><span class="p">,</span> <span class="nv">$name</span><span class="p">);</span>
</span><span class='line'><span class="nv">$sth</span><span class="o">-&gt;</span><span class="na">bindeValue</span><span class="p">(</span><span class="s2">&quot;:email&quot;</span><span class="p">,</span> <span class="nv">$email</span><span class="p">);</span>
</span><span class='line'><span class="nv">$sth</span><span class="o">-&gt;</span><span class="na">bindeValue</span><span class="p">(</span><span class="s2">&quot;:id&quot;</span><span class="p">,</span> <span class="nv">$id</span><span class="p">,</span> <span class="nx">PDO</span><span class="o">::</span><span class="na">PARAM_INT</span><span class="p">);</span>
</span><span class='line'><span class="nv">$sth</span><span class="o">-&gt;</span><span class="na">execute</span><span class="p">();</span>
</span></code></pre></td></tr></table></div></figure>


<p>With Doctrine DBAL you can combine preparing and executing into one step.</p>

<figure class='code'><figcaption><span>Preparing and Executing in one command</span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
</pre></td><td class='code'><pre><code class='php'><span class='line'><span class="nv">$sth</span> <span class="o">=</span> <span class="nv">$conn</span><span class="o">-&gt;</span><span class="na">executeQuery</span><span class="p">(</span><span class="s1">&#39;SELECT * FROM users WHERE email = ?&#39;</span><span class="p">,</span> <span class="k">array</span><span class="p">(</span><span class="s1">&#39;email@excample.com&#39;</span><span class="p">));</span>
</span><span class='line'><span class="nv">$user</span> <span class="o">=</span> <span class="nv">$sth</span><span class="o">-&gt;</span><span class="na">fetch</span><span class="p">();</span>
</span><span class='line'>
</span><span class='line'><span class="c1">// executeUpdate will return the number of affected rows</span>
</span><span class='line'><span class="nv">$count</span> <span class="o">=</span> <span class="nv">$dbh</span><span class="o">-&gt;</span><span class="na">executeUpdate</span><span class="p">(</span><span class="s2">&quot;UPDATE users SET name = ?, email = ? WHERE id = ?&quot;</span><span class="p">,</span> <span class="k">array</span><span class="p">(</span><span class="nv">$name</span><span class="p">,</span> <span class="nv">$email</span><span class="p">,</span> <span class="nv">$id</span><span class="p">));</span>
</span><span class='line'><span class="c1">// Same with named parameters</span>
</span><span class='line'><span class="nv">$count</span> <span class="o">=</span> <span class="nv">$dbh</span><span class="o">-&gt;</span><span class="na">executeUpdate</span><span class="p">(</span><span class="s2">&quot;UPDATE users SET name = :name, email = :email WHERE id = :id&quot;</span><span class="p">,</span> <span class="k">array</span><span class="p">(</span><span class="s1">&#39;name&#39;</span> <span class="o">=&gt;</span> <span class="nv">$name</span><span class="p">,</span> <span class="s1">&#39;email&#39;</span> <span class="o">=&gt;</span> <span class="nv">$email</span><span class="p">,</span> <span class="s1">&#39;id&#39;</span> <span class="o">=&gt;</span> <span class="nv">$id</span><span class="p">));</span>
</span><span class='line'>
</span><span class='line'><span class="c1">// You can even prepare, execute, and fetch in one step</span>
</span><span class='line'><span class="nv">$users</span> <span class="o">=</span> <span class="nv">$dbh</span><span class="o">-&gt;</span><span class="na">fetchAll</span><span class="p">(</span><span class="s2">&quot;SELECT * FROM users WHERE name LIKE ?&quot;</span><span class="p">,</span> <span class="k">array</span><span class="p">(</span><span class="nv">$name</span> <span class="o">.</span> <span class="s1">&#39;%&#39;</span><span class="p">));</span>
</span></code></pre></td></tr></table></div></figure>


<h2>Inserts, Updates, and Deletes</h2>

<p>With Doctrine DBAL you don&rsquo;t even need to write sql for inserts, updates, and deletes.</p>

<figure class='code'><figcaption><span>Inserts</span><a href='http://docs.doctrine-project.org/projects/doctrine-dbal/en/latest/reference/data-retrieval-and-manipulation.html#insert'>link</a></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
</pre></td><td class='code'><pre><code class='php'><span class='line'><span class="c1">// Insert a new user into the users table</span>
</span><span class='line'><span class="nv">$dbh</span><span class="o">-&gt;</span><span class="na">insert</span><span class="p">(</span><span class="s1">&#39;users&#39;</span><span class="p">,</span> <span class="k">array</span><span class="p">(</span><span class="s1">&#39;name&#39;</span> <span class="o">=&gt;</span> <span class="s1">&#39;Bob&#39;</span><span class="p">,</span> <span class="s1">&#39;email&#39;</span> <span class="o">=&gt;</span> <span class="s1">&#39;bob@example.com&#39;</span><span class="p">));</span>
</span><span class='line'><span class="c1">// This is the same as running the following query</span>
</span><span class='line'><span class="c1">// INSERT INTO users (name, email) VALUES (&#39;Bob&#39;, &#39;bob@example.com&#39;)</span>
</span></code></pre></td></tr></table></div></figure>




<figure class='code'><figcaption><span>Updates</span><a href='http://docs.doctrine-project.org/projects/doctrine-dbal/en/latest/reference/data-retrieval-and-manipulation.html#update'>link</a></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
</pre></td><td class='code'><pre><code class='php'><span class='line'><span class="nv">$dbh</span><span class="o">-&gt;</span><span class="na">update</span><span class="p">(</span><span class="s1">&#39;users&#39;</span><span class="p">,</span> <span class="k">array</span><span class="p">(</span><span class="s1">&#39;name&#39;</span> <span class="o">=&gt;</span> <span class="s1">&#39;Bob&#39;</span><span class="p">),</span> <span class="k">array</span><span class="p">(</span><span class="s1">&#39;id&#39;</span> <span class="o">=&gt;</span> <span class="mi">1</span><span class="p">));</span>
</span><span class='line'><span class="c1">// This is the same as running the following query</span>
</span><span class='line'><span class="c1">// UPDATE users SET name = &#39;Bob&#39; WHERE id = 1</span>
</span></code></pre></td></tr></table></div></figure>




<figure class='code'><figcaption><span>Deletes</span><a href='http://docs.doctrine-project.org/projects/doctrine-dbal/en/latest/reference/data-retrieval-and-manipulation.html#delete'>link</a></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
</pre></td><td class='code'><pre><code class='php'><span class='line'><span class="nv">$dbh</span><span class="o">-&gt;</span><span class="na">delete</span><span class="p">(</span><span class="s1">&#39;users&#39;</span><span class="p">,</span> <span class="k">array</span><span class="p">(</span><span class="s1">&#39;id&#39;</span> <span class="o">=&gt;</span> <span class="mi">1</span><span class="p">));</span>
</span><span class='line'><span class="c1">// This is the same as running the following query</span>
</span><span class='line'><span class="c1">// DELETE FROM users WHERE id = 1</span>
</span></code></pre></td></tr></table></div></figure>


<h2>Query Builder</h2>

<p>Doctrine DBAL also features a <a href="http://docs.doctrine-project.org/projects/doctrine-dbal/en/latest/reference/query-builder.html">query builderr</a> to help build complicated SQL queries.</p>

<figure class='code'><figcaption><span>Query Builder</span><a href='http://docs.doctrine-project.org/projects/doctrine-dbal/en/latest/reference/query-builder.html'>link</a></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
</pre></td><td class='code'><pre><code class='php'><span class='line'><span class="c1">// This will run the following query</span>
</span><span class='line'><span class="cm">/*</span>
</span><span class='line'><span class="cm">SELECT u.id, u.name, u.email, p.bio</span>
</span><span class='line'><span class="cm">FROM users u</span>
</span><span class='line'><span class="cm">INNER JOIN user_profile p ON (u.id = p.user_id)</span>
</span><span class='line'><span class="cm">WHERE u.id = 1</span>
</span><span class='line'><span class="cm">ORDER BY u.name ASC</span>
</span><span class='line'><span class="cm">*/</span>
</span><span class='line'><span class="nv">$id</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
</span><span class='line'><span class="nv">$query</span> <span class="o">=</span> <span class="nv">$dbh</span><span class="o">-&gt;</span><span class="na">createQueryBuilder</span><span class="p">();</span>
</span><span class='line'><span class="nv">$query</span><span class="o">-&gt;</span><span class="na">select</span><span class="p">(</span><span class="s1">&#39;u.id&#39;</span><span class="p">,</span> <span class="s1">&#39;u.name&#39;</span><span class="p">,</span> <span class="s1">&#39;u.email&#39;</span><span class="p">,</span> <span class="s1">&#39;p.bio&#39;</span><span class="p">)</span>
</span><span class='line'>      <span class="o">-&gt;</span><span class="na">from</span><span class="p">(</span><span class="s1">&#39;users&#39;</span><span class="p">,</span> <span class="s1">&#39;u&#39;</span><span class="p">)</span>
</span><span class='line'>      <span class="o">-&gt;</span><span class="na">innerJoin</span><span class="p">(</span><span class="s1">&#39;u&#39;</span><span class="p">,</span> <span class="s1">&#39;user_profile&#39;</span><span class="p">,</span> <span class="s1">&#39;p&#39;</span><span class="p">,</span> <span class="s1">&#39;u.id = p.user_id&#39;</span><span class="p">)</span>
</span><span class='line'>      <span class="o">-&gt;</span><span class="na">orderBy</span><span class="p">(</span><span class="s1">&#39;u.name&#39;</span><span class="p">,</span> <span class="s1">&#39;ASC&#39;</span><span class="p">)</span>
</span><span class='line'>      <span class="o">-&gt;</span><span class="na">where</span><span class="p">(</span><span class="s1">&#39;u.id = :id&#39;</span><span class="p">)</span>
</span><span class='line'>      <span class="o">-&gt;</span><span class="na">setParameter</span><span class="p">(</span><span class="s1">&#39;:id&#39;</span><span class="p">,</span> <span class="nv">$id</span><span class="p">)</span>
</span><span class='line'><span class="p">;</span>
</span><span class='line'><span class="nv">$sth</span> <span class="o">=</span> <span class="nv">$query</span><span class="o">-&gt;</span><span class="na">execute</span><span class="p">();</span>
</span><span class='line'><span class="nv">$user</span> <span class="o">=</span> <span class="nv">$sth</span><span class="o">-&gt;</span><span class="na">fetchAssoc</span><span class="p">();</span>
</span></code></pre></td></tr></table></div></figure>


<p>Where I find the query builder to be the most helpful is when you have parts of the query that are dependent on user provided data.</p>

<p>For example imagine a page with a search form with multiple fields that filter results by different columns.<br/>
You might have a text field to search the names of users and another text field to search by email address.<br/>
There is also a select box to search by account type with the values Any, Editors, and Members.<br/>
If Any is selected you do not want to filter by account type but if Editors or Members is selected you do.<br/>
With the other fields you only want to filter them if the user entered anything in the fields.
You always only want to return active accounts.</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
</pre></td><td class='code'><pre><code class='php'><span class='line'><span class="c1">// User provided search data</span>
</span><span class='line'><span class="nv">$search</span> <span class="o">=</span> <span class="k">array</span><span class="p">(</span>
</span><span class='line'>  <span class="s1">&#39;name&#39;</span> <span class="o">=&gt;</span> <span class="s1">&#39;Bob&#39;</span><span class="p">,</span>
</span><span class='line'>  <span class="s1">&#39;email&#39;</span> <span class="o">=&gt;</span> <span class="k">null</span><span class="p">,</span>
</span><span class='line'>  <span class="s1">&#39;type&#39;</span> <span class="o">=&gt;</span> <span class="s1">&#39;any&#39;</span>
</span><span class='line'><span class="p">);</span>
</span><span class='line'>
</span><span class='line'><span class="c1">// Query That should be run</span>
</span><span class='line'><span class="c1">// SELECT * FROM users WHERE name LIKE &#39;%Bob%&#39;</span>
</span></code></pre></td></tr></table></div></figure>




<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
</pre></td><td class='code'><pre><code class='php'><span class='line'><span class="c1">// User provided search data</span>
</span><span class='line'><span class="nv">$search</span> <span class="o">=</span> <span class="k">array</span><span class="p">(</span>
</span><span class='line'>  <span class="s1">&#39;name&#39;</span> <span class="o">=&gt;</span> <span class="s1">&#39;Bob&#39;</span><span class="p">,</span>
</span><span class='line'>  <span class="s1">&#39;email&#39;</span> <span class="o">=&gt;</span> <span class="s1">&#39;email@example.com&#39;</span><span class="p">,</span>
</span><span class='line'>  <span class="s1">&#39;type&#39;</span> <span class="o">=&gt;</span> <span class="s1">&#39;member&#39;</span>
</span><span class='line'><span class="p">);</span>
</span><span class='line'>
</span><span class='line'><span class="c1">// Query That should be run</span>
</span><span class='line'><span class="c1">// SELECT * FROM users WHERE active = 1 AND name LIKE &#39;%Bob%&#39; AND email LIKE &#39;%email@example.com%&#39; AND type = &#39;member&#39; ORDER BY name ASC</span>
</span></code></pre></td></tr></table></div></figure>


<p>With straight SQL the only way to build this query is with string concatenation.</p>

<figure class='code'><figcaption><span>Building query with string concatenation and PDO</span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
</pre></td><td class='code'><pre><code class='php'><span class='line'><span class="nv">$where</span> <span class="o">=</span> <span class="k">array</span><span class="p">(</span><span class="s2">&quot;active = 1&quot;</span><span class="p">);</span>
</span><span class='line'><span class="k">if</span> <span class="p">(</span><span class="nv">$search</span><span class="p">[</span><span class="s1">&#39;name&#39;</span><span class="p">])</span> <span class="p">{</span>
</span><span class='line'>    <span class="nv">$where</span><span class="p">[]</span> <span class="o">=</span> <span class="s2">&quot;name LIKE :name&quot;</span><span class="p">;</span>
</span><span class='line'><span class="p">}</span>
</span><span class='line'><span class="k">if</span> <span class="p">(</span><span class="nv">$search</span><span class="p">[</span><span class="s1">&#39;email&#39;</span><span class="p">])</span> <span class="p">{</span>
</span><span class='line'>    <span class="nv">$where</span><span class="p">[]</span> <span class="o">=</span> <span class="s2">&quot;email LIKE :email&quot;</span><span class="p">;</span>
</span><span class='line'><span class="p">}</span>
</span><span class='line'><span class="k">if</span> <span class="p">(</span><span class="nv">$search</span><span class="p">[</span><span class="s1">&#39;type&#39;</span><span class="p">]</span> <span class="o">!=</span> <span class="s1">&#39;any&#39;</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>    <span class="nv">$where</span><span class="p">[]</span> <span class="o">=</span> <span class="s2">&quot;type = :type&quot;</span><span class="p">;</span>
</span><span class='line'><span class="p">}</span>
</span><span class='line'><span class="k">if</span> <span class="p">(</span><span class="nv">$where</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>    <span class="nv">$where</span> <span class="o">=</span> <span class="nb">implode</span><span class="p">(</span><span class="s2">&quot; AND &quot;</span><span class="p">,</span> <span class="nv">$where</span><span class="p">);</span>
</span><span class='line'><span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
</span><span class='line'>    <span class="nv">$where</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span><span class="p">;</span>
</span><span class='line'><span class="p">}</span>
</span><span class='line'>
</span><span class='line'><span class="nv">$sql</span> <span class="o">=</span> <span class="s2">&quot;SELECT * FROM users WHERE &quot;</span> <span class="o">.</span> <span class="nv">$where</span> <span class="o">.</span> <span class="s2">&quot; ORDER BY name ASC&quot;</span><span class="p">;</span>
</span><span class='line'><span class="nv">$sth</span> <span class="o">=</span> <span class="nv">$dbh</span><span class="o">-&gt;</span><span class="na">prepare</span><span class="p">(</span><span class="nv">$sql</span><span class="p">);</span>
</span><span class='line'><span class="k">if</span> <span class="p">(</span><span class="nv">$search</span><span class="p">[</span><span class="s1">&#39;name&#39;</span><span class="p">])</span> <span class="p">{</span>
</span><span class='line'>    <span class="nv">$sth</span><span class="o">-&gt;</span><span class="na">bindValue</span><span class="p">(</span><span class="s1">&#39;:name&#39;</span><span class="p">,</span> <span class="s2">&quot;%&quot;</span> <span class="o">.</span> <span class="nv">$search</span><span class="p">[</span><span class="s1">&#39;name&#39;</span><span class="p">]</span> <span class="o">.</span> <span class="s2">&quot;%&quot;</span><span class="p">);</span>
</span><span class='line'><span class="p">}</span>
</span><span class='line'><span class="k">if</span> <span class="p">(</span><span class="nv">$search</span><span class="p">[</span><span class="s1">&#39;email&#39;</span><span class="p">])</span> <span class="p">{</span>
</span><span class='line'>    <span class="nv">$sth</span><span class="o">-&gt;</span><span class="na">bindValue</span><span class="p">(</span><span class="s1">&#39;:email&#39;</span><span class="p">,</span> <span class="s2">&quot;%&quot;</span> <span class="o">.</span> <span class="nv">$search</span><span class="p">[</span><span class="s1">&#39;email&#39;</span><span class="p">]</span> <span class="o">.</span> <span class="s2">&quot;%&quot;</span><span class="p">);</span>
</span><span class='line'><span class="p">}</span>
</span><span class='line'><span class="k">if</span> <span class="p">(</span><span class="nv">$search</span><span class="p">[</span><span class="s1">&#39;type&#39;</span><span class="p">]</span> <span class="o">!=</span> <span class="s1">&#39;any&#39;</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>    <span class="nv">$sth</span><span class="o">-&gt;</span><span class="na">bindValue</span><span class="p">(</span><span class="s1">&#39;:type&#39;</span><span class="p">,</span> <span class="nv">$search</span><span class="p">[</span><span class="s1">&#39;type&#39;</span><span class="p">]);</span>
</span><span class='line'><span class="p">}</span>
</span><span class='line'><span class="nv">$sth</span><span class="o">-&gt;</span><span class="na">execute</span><span class="p">();</span>
</span><span class='line'><span class="nv">$users</span> <span class="o">=</span> <span class="nv">$sth</span><span class="o">-&gt;</span><span class="na">fetchAll</span><span class="p">(</span><span class="nx">PDO</span><span class="o">::</span><span class="na">FETCH_ASSOC</span><span class="p">);</span>
</span></code></pre></td></tr></table></div></figure>


<p>This example is actually pretty simple and the code is already difficult to understand.</p>

<p>Lets look at the same example using the query builder</p>

<figure class='code'><figcaption><span>Using the query builder</span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
</pre></td><td class='code'><pre><code class='php'><span class='line'><span class="nv">$query</span> <span class="o">=</span> <span class="nv">$dbh</span><span class="o">-&gt;</span><span class="na">createQueryBuilder</span><span class="p">();</span>
</span><span class='line'><span class="nv">$query</span><span class="o">-&gt;</span><span class="na">select</span><span class="p">(</span><span class="s1">&#39;*&#39;</span><span class="p">);</span>
</span><span class='line'><span class="nv">$query</span><span class="o">-&gt;</span><span class="na">from</span><span class="p">(</span><span class="s1">&#39;users&#39;</span><span class="p">);</span>
</span><span class='line'><span class="nv">$query</span><span class="o">-&gt;</span><span class="na">where</span><span class="p">(</span><span class="s2">&quot;active = 1&quot;</span><span class="p">);</span>
</span><span class='line'><span class="k">if</span> <span class="p">(</span><span class="nv">$search</span><span class="p">[</span><span class="s1">&#39;name&#39;</span><span class="p">])</span> <span class="p">{</span>
</span><span class='line'>    <span class="nv">$query</span><span class="o">-&gt;</span><span class="na">andWhere</span><span class="p">(</span><span class="s1">&#39;name LIKE :name&#39;</span><span class="p">);</span>
</span><span class='line'>    <span class="nv">$query</span><span class="o">-&gt;</span><span class="na">setParameter</span><span class="p">(</span><span class="s1">&#39;:name&#39;</span><span class="p">,</span> <span class="s2">&quot;%&quot;</span> <span class="o">.</span> <span class="nv">$search</span><span class="p">[</span><span class="s1">&#39;name&#39;</span><span class="p">]</span> <span class="o">.</span> <span class="s2">&quot;%&quot;</span><span class="p">);</span>
</span><span class='line'><span class="p">}</span>
</span><span class='line'><span class="k">if</span> <span class="p">(</span><span class="nv">$search</span><span class="p">[</span><span class="s1">&#39;email&#39;</span><span class="p">])</span> <span class="p">{</span>
</span><span class='line'>    <span class="nv">$query</span><span class="o">-&gt;</span><span class="na">andWhere</span><span class="p">(</span><span class="s1">&#39;email LIKE :email&#39;</span><span class="p">);</span>
</span><span class='line'>    <span class="nv">$query</span><span class="o">-&gt;</span><span class="na">setParameter</span><span class="p">(</span><span class="s1">&#39;:email&#39;</span><span class="p">,</span> <span class="s2">&quot;%&quot;</span> <span class="o">.</span> <span class="nv">$search</span><span class="p">[</span><span class="s1">&#39;email&#39;</span><span class="p">]</span> <span class="o">.</span> <span class="s2">&quot;%&quot;</span><span class="p">);</span>
</span><span class='line'><span class="p">}</span>
</span><span class='line'><span class="k">if</span> <span class="p">(</span><span class="nv">$search</span><span class="p">[</span><span class="s1">&#39;type&#39;</span><span class="p">]</span> <span class="o">!=</span> <span class="s1">&#39;any&#39;</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>    <span class="nv">$query</span><span class="o">-&gt;</span><span class="na">andWhere</span><span class="p">(</span><span class="s1">&#39;type = :type&#39;</span><span class="p">);</span>
</span><span class='line'>    <span class="nv">$query</span><span class="o">-&gt;</span><span class="na">setParameter</span><span class="p">(</span><span class="s1">&#39;:type&#39;</span><span class="p">,</span> <span class="nv">$search</span><span class="p">[</span><span class="s1">&#39;type&#39;</span><span class="p">]);</span>
</span><span class='line'><span class="p">}</span>
</span><span class='line'><span class="nv">$query</span><span class="o">-&gt;</span><span class="na">orderBy</span><span class="p">(</span><span class="s1">&#39;name&#39;</span><span class="p">,</span> <span class="s1">&#39;ASC&#39;</span><span class="p">);</span>
</span><span class='line'><span class="nv">$sth</span> <span class="o">=</span> <span class="nv">$query</span><span class="o">-&gt;</span><span class="na">execute</span><span class="p">();</span>
</span><span class='line'><span class="nv">$users</span> <span class="o">=</span> <span class="nv">$sth</span><span class="o">-&gt;</span><span class="na">fetchAll</span><span class="p">(</span><span class="nx">PDO</span><span class="o">::</span><span class="na">FETCH_ASSOC</span><span class="p">);</span>
</span></code></pre></td></tr></table></div></figure>


<p>Not only is that code shorter but if you read it out loud it even sounds more like English.<br/>
This greatly helps at understanding what the code does at a glance 6 months later.</p>

<p>The query builder does result in some extra overhead as it needs to compile the query so raw SQL is generally a better idea if the query is simple.</p>

<h2>Conclusion</h2>

<p>Doctrine DBAL adds a lot of functionality for a very lightweight overhead.
Even if you don&rsquo;t use the query builder it is worth it for the shorter syntax on inserts, updates, and deletes as well as the ability to prepare, execute, and fetch data in one statement.</p>

<p>There is a lot more functionality I didn&rsquo;t cover so I recommend taking a look at <a href="http://docs.doctrine-project.org/projects/doctrine-dbal/en/latest/index.html">the documentationn</a>
for other pieces of functionality such as events, a schema manager, caching, sharding, and more.</p>
]]></content>
  </entry>
  
  <entry>
    <title type="html"><![CDATA[Moving from mysql_query to PDO]]></title>
    <link href="http://www.thedevfiles.com/2014/08/moving-from-mysql-query-to-pdo/"/>
    <updated>2014-08-08T00:00:00-07:00</updated>
    <id>http://www.thedevfiles.com/2014/08/moving-from-mysql-query-to-pdo</id>
    <content type="html"><![CDATA[<p>The mysql extension has been marked as deprecated as of php 5.5.0 and will be removed completely in a future version.</p>

<p>It is old and not very user friendly.</p>

<p>This article will introduce PDO as a replacement.</p>

<!--more-->


<h2>Connecting to a Database</h2>

<h3>Connecting with mysql_connect</h3>

<figure class='code'><figcaption><span>mysql_connect</span><a href='http://us2.php.net/manual/en/function.mysql-connect.php'>docs</a></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class='php'><span class='line'><span class="nv">$link</span> <span class="o">=</span> <span class="nb">mysql_connect</span><span class="p">(</span><span class="s1">&#39;localhost&#39;</span><span class="p">,</span> <span class="s1">&#39;user&#39;</span><span class="p">,</span> <span class="s1">&#39;password&#39;</span><span class="p">);</span>
</span><span class='line'><span class="nb">mysql_select_db</span><span class="p">(</span><span class="s1">&#39;database&#39;</span><span class="p">,</span> <span class="nv">$link</span><span class="p">);</span>
</span></code></pre></td></tr></table></div></figure>


<p>The <a href="http://us3.php.net/manual/en/function.mysql-connect.php">mysql_connect</a> function returns a MySQL link identifier if the database connection was successful or FALSE if the connection was not successful.<br/>
After connecting to the database server the database must be selected before any queries can be run on it.<br/>
This is done with the <a href="http://us3.php.net/manual/en/function.mysql-select-db.php">mysql_select_db</a> function.</p>

<h3>Connecting with PDO</h3>

<figure class='code'><figcaption><span>PDO</span><a href='http://us3.php.net/manual/en/pdo.construct.php'>docs</a></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='php'><span class='line'><span class="nv">$dbh</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">PDO</span><span class="p">(</span><span class="s1">&#39;mysql:host=localhost;dbname=database&#39;</span><span class="p">,</span> <span class="s1">&#39;user&#39;</span><span class="p">,</span> <span class="s1">&#39;password&#39;</span><span class="p">);</span>
</span></code></pre></td></tr></table></div></figure>


<p>The <a href="http://us3.php.net/manual/en/pdo.construct.php">PDO constructor</a> accepts a <abbr title="Data Source Name">DSN</abbr> as the first parameter and the user and password as the second and third parameter.</p>

<p>This will create a new PDO instance if successful or throw a <a href="http://us3.php.net/manual/en/class.pdoexception.php">PDOException</a> if the connection fails.<br/>
I will go into error handling later on.</p>

<h2>Running a Query</h2>

<h3>Running a query with mysql_query</h3>

<figure class='code'><figcaption><span>mysql_query</span><a href='http://us2.php.net/manual/en/function.mysql-query.php'>docs</a></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='php'><span class='line'><span class="nv">$result</span> <span class="o">=</span> <span class="nb">mysql_query</span><span class="p">(</span><span class="s2">&quot;SELECT * FROM tablename&quot;</span><span class="p">,</span> <span class="nv">$link</span><span class="p">);</span>
</span></code></pre></td></tr></table></div></figure>


<p>The <a href="http://us3.php.net/manual/en/function.mysql-query.php">mysql_query</a> function accepts the sql query as a string for the first parameter and the mysql link identifier returned from the mysql_connect function as the second parameter.<br/>
For a successfully query it returns a resource for a query that would return a result-set such as a SELECT query and TRUE for a INSERT, UPDATE, or DELETE query.<br/>
It returns FALSE if the query fails.</p>

<h3>Running a query with PDO</h3>

<figure class='code'><figcaption><span>PDO::query</span><a href='http://us3.php.net/manual/en/pdo.query.php'>docs</a></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='php'><span class='line'><span class="nv">$sth</span> <span class="o">=</span> <span class="nv">$dbh</span><span class="o">-&gt;</span><span class="na">query</span><span class="p">(</span><span class="s2">&quot;SELECT * FROM tablename&quot;</span><span class="p">);</span>
</span></code></pre></td></tr></table></div></figure>


<p>The <a href="http://us3.php.net/manual/en/pdo.query.php">query</a> method on the PDO object accepts the sql query as its only parameter.<br/>
By default it returns an instance of <a href="http://us3.php.net/manual/en/class.pdostatement.php">PDOStatement</a> if successful or FALSE if not.<br/>
This can be changed my modifying the error mode for the connection.  This will be explained further in the Handling Errors section.</p>

<h2>Fetching Data</h2>

<h3>Fetching a single row with mysql_fetch_assoc</h3>

<figure class='code'><figcaption><span>mysql_fetch_assoc</span><a href='http://us2.php.net/manual/en/function.mysql-fetch-assoc.php'>docs</a></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
</pre></td><td class='code'><pre><code class='php'><span class='line'><span class="nv">$users</span> <span class="o">=</span> <span class="k">array</span><span class="p">();</span>
</span><span class='line'><span class="nv">$result</span> <span class="o">=</span> <span class="nb">mysql_query</span><span class="p">(</span><span class="s2">&quot;SELECT * FROM users WHERE id = 1&quot;</span><span class="p">,</span> <span class="nv">$link</span><span class="p">);</span>
</span><span class='line'><span class="nv">$user</span> <span class="o">=</span> <span class="nb">mysql_fetch_assoc</span><span class="p">(</span><span class="nv">$result</span><span class="p">)</span>
</span></code></pre></td></tr></table></div></figure>


<p>To get the data from a query you can use the mysql_fetch_* functions.
To return the data as an associative array use the <a href="http://us3.php.net/manual/en/function.mysql-fetch-assoc.php">mysql_fetch_assoc</a> function.
To return the data as a numeric indexed array use the <a href="http://us3.php.net/manual/en/function.mysql-fetch-row.php">mysql_fetch_row</a> function.
To return the data as an object use the <a href="http://us3.php.net/manual/en/function.mysql-fetch-object.php">mysql_fetch_object</a> function.
It will return the next row in the result-set or FALSE of there are no more rows.</p>

<h3>Fetching a single row with PDO</h3>

<figure class='code'><figcaption><span>PDOStatement::fetch</span><a href='http://us3.php.net/manual/en/pdostatement.fetch.php'>docs</a></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class='php'><span class='line'><span class="nv">$sth</span> <span class="o">=</span> <span class="nv">$dbh</span><span class="o">-&gt;</span><span class="na">query</span><span class="p">(</span><span class="s2">&quot;SELECT * FROM users WHERE id = 1&quot;</span><span class="p">);</span>
</span><span class='line'><span class="nv">$user</span> <span class="o">=</span> <span class="nv">$sth</span><span class="o">-&gt;</span><span class="na">fetch</span><span class="p">(</span><span class="nx">PDO</span><span class="o">::</span><span class="na">FETCH_ASSOC</span><span class="p">);</span>
</span></code></pre></td></tr></table></div></figure>


<p>You can use the <a href="http://us3.php.net/manual/en/pdostatement.fetch.php">fetch</a> method on the <a href="http://us3.php.net/manual/en/class.pdostatement.php">PDOStatement</a> object returned from the <a href="http://us3.php.net/manual/en/pdo.query.php">PDO::query</a> method.<br/>
It accepts the fetch style as the first parameter.<br/>
To return data as an associative array pass the PDO::FETCH_ASSOC constant.<br/>
To return data as a numeric indexed array pass the PDO::FETCH_NUM constant.<br/>
To return data as an object pass the PDO::FETCH_OBJ constant.</p>

<h3>Fetching all rows with mysql_fetch_assoc</h3>

<figure class='code'><figcaption><span>mysql_fetch_assoc</span><a href='http://us2.php.net/manual/en/function.mysql-fetch-assoc.php'>docs</a></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
</pre></td><td class='code'><pre><code class='php'><span class='line'><span class="nv">$users</span> <span class="o">=</span> <span class="k">array</span><span class="p">();</span>
</span><span class='line'><span class="nv">$result</span> <span class="o">=</span> <span class="nb">mysql_query</span><span class="p">(</span><span class="s2">&quot;SELECT * FROM users&quot;</span><span class="p">,</span> <span class="nv">$link</span><span class="p">);</span>
</span><span class='line'><span class="k">while</span> <span class="p">(</span><span class="nv">$row</span> <span class="o">=</span> <span class="nb">mysql_fetch_assoc</span><span class="p">(</span><span class="nv">$result</span><span class="p">))</span> <span class="p">{</span>
</span><span class='line'>    <span class="nv">$users</span><span class="p">[]</span> <span class="o">=</span> <span class="nv">$row</span><span class="p">;</span>
</span><span class='line'><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>To fetch all of the rows from a result-set you will need to loop through calling mysql_fetch_* until it returns false.<br/>
This will result in an multi-dimensional associative array with all the records in the users table.</p>

<h3>Fetching all rows with PDO::fetchAll</h3>

<figure class='code'><figcaption><span>PDOStatement::fetchAll</span><a href='http://us3.php.net/manual/en/pdostatement.fetchall.php'>docs</a></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class='php'><span class='line'><span class="nv">$sth</span> <span class="o">=</span> <span class="nv">$dbh</span><span class="o">-&gt;</span><span class="na">query</span><span class="p">(</span><span class="s2">&quot;SELECT * FROM users&quot;</span><span class="p">);</span>
</span><span class='line'><span class="nv">$users</span> <span class="o">=</span> <span class="nv">$sth</span><span class="o">-&gt;</span><span class="na">fetchAll</span><span class="p">(</span><span class="nx">PDO</span><span class="o">::</span><span class="na">FETCH_ASSOC</span><span class="p">);</span>
</span></code></pre></td></tr></table></div></figure>


<p>There is no need to loop to pull an entire result-set with PDO.<br/>
Just use the <a href="http://us3.php.net/manual/en/pdostatement.fetchall.php">PDOStatement::fetchAll</a> method passing the result style you want.</p>

<h3>Getting the row id of the inserted record with mysql_insert_id</h3>

<figure class='code'><figcaption><span>mysql_insert_id</span><a href='http://us2.php.net/manual/en/function.mysql-insert-id.php'>docs</a></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class='php'><span class='line'><span class="nb">mysql_query</span><span class="p">(</span><span class="s2">&quot;INSERT INTO users (first_name, last_name, email_address) VALUES (&#39;John&#39;, &#39;Doe&#39;, &#39;email@example.com&#39;)&quot;</span><span class="p">,</span> <span class="nv">$link</span><span class="p">);</span>
</span><span class='line'><span class="nv">$id</span> <span class="o">=</span> <span class="nb">mysql_insert_id</span><span class="p">(</span><span class="nv">$link</span><span class="p">);</span>
</span></code></pre></td></tr></table></div></figure>


<p>After performing an insert query call <a href="http://us3.php.net/manual/en/function.mysql-insert-id.php">mysql_insert_id</a> to get the row id of the last inserted record.</p>

<h3>Getting the row id of the inserted record with PDO::lastInsertId</h3>

<figure class='code'><figcaption><span>PDO::lastInsertId</span><a href='http://us3.php.net/manual/en/pdo.lastinsertid.php'>docs</a></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class='php'><span class='line'><span class="nv">$dbh</span><span class="o">-&gt;</span><span class="na">query</span><span class="p">(</span><span class="s2">&quot;INSERT INTO users (first_name, last_name, email_address) VALUES (&#39;John&#39;, &#39;Doe&#39;, &#39;email@example.com&#39;)&quot;</span><span class="p">,</span> <span class="nv">$link</span><span class="p">);</span>
</span><span class='line'><span class="nv">$id</span> <span class="o">=</span> <span class="nv">$dbh</span><span class="o">-&gt;</span><span class="na">lastInsertId</span><span class="p">();</span>
</span></code></pre></td></tr></table></div></figure>


<p>After performing an insert query call the <a href="http://us3.php.net/manual/en/pdo.lastinsertid.php">PDO::lastInsertId</a> method to get the row id of the last inserted record.</p>

<h2>Other Fetching Methods</h2>

<p>One feature in PDO that isn&rsquo;t available in the mysql extension is a couple more advanced fetching methods.</p>

<p>I&rsquo;ve already shown you the <a href="http://php.net/manual/en/pdostatement.fetch.php">PDOStatement::fetch</a> method to fetch a single row and the <a href="http://php.net/manual/en/pdostatement.fetchall.php">PDOStatement ::fetchAll</a> method to fetch all rows.</p>

<h3>Fetching a single column from a single record</h3>

<p>Say you want to pull the user id of a user with a given email address.
You do not need any of the other user data, just the id.</p>

<p>With the mysql extension you would end up with an array with one key an value.</p>

<figure class='code'><figcaption><span>Using mysql_query</span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
</pre></td><td class='code'><pre><code class='php'><span class='line'><span class="nv">$result</span> <span class="o">=</span> <span class="nb">mysql_query</span><span class="p">(</span><span class="s2">&quot;SELECT id FROM users WHERE email = &#39;bob@example.com&#39;&quot;</span><span class="p">,</span> <span class="nv">$link</span><span class="p">);</span>
</span><span class='line'><span class="nv">$row</span> <span class="o">=</span> <span class="nb">mysql_fetch_assoc</span><span class="p">(</span><span class="nv">$result</span><span class="p">);</span>
</span><span class='line'><span class="k">if</span> <span class="p">(</span><span class="nv">$row</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>    <span class="nv">$id</span> <span class="o">=</span> <span class="nv">$row</span><span class="p">[</span><span class="s1">&#39;id&#39;</span><span class="p">];</span>
</span><span class='line'><span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
</span><span class='line'>    <span class="nv">$id</span> <span class="o">=</span> <span class="k">false</span><span class="p">;</span>
</span><span class='line'><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>With PDO you can fetch the id as a scalar value</p>

<figure class='code'><figcaption><span>Using PDO</span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class='php'><span class='line'><span class="nv">$sth</span> <span class="o">=</span> <span class="nv">$dbh</span><span class="o">-&gt;</span><span class="na">query</span><span class="p">(</span><span class="s2">&quot;SELECT id FROM users WHERE email = &#39;bob@example.com&#39;&quot;</span><span class="p">);</span>
</span><span class='line'><span class="nv">$id</span> <span class="o">=</span> <span class="nv">$sth</span><span class="o">-&gt;</span><span class="na">fetchColumn</span><span class="p">();</span>
</span></code></pre></td></tr></table></div></figure>


<h3>Fetching an array of scalar values</h3>

<p>Now say you wanted an array of user ids for all active users.</p>

<figure class='code'><figcaption><span>Using mysql_query</span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
</pre></td><td class='code'><pre><code class='php'><span class='line'><span class="nv">$users</span> <span class="o">=</span> <span class="k">array</span><span class="p">();</span>
</span><span class='line'><span class="nv">$result</span> <span class="o">=</span> <span class="nb">mysql_query</span><span class="p">(</span><span class="s2">&quot;SELECT id FROM users WHERE active = 1&quot;</span><span class="p">,</span> <span class="nv">$link</span><span class="p">);</span>
</span><span class='line'><span class="k">while</span> <span class="p">(</span><span class="nv">$row</span> <span class="o">=</span> <span class="nb">mysql_fetch_assoc</span><span class="p">(</span><span class="nv">$result</span><span class="p">))</span> <span class="p">{</span>
</span><span class='line'>    <span class="nv">$users</span><span class="p">[]</span> <span class="o">=</span> <span class="nv">$row</span><span class="p">[</span><span class="s1">&#39;id&#39;</span><span class="p">];</span>
</span><span class='line'><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>




<figure class='code'><figcaption><span>Using PDO</span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class='php'><span class='line'><span class="nv">$sth</span> <span class="o">=</span> <span class="nv">$dbh</span><span class="o">-&gt;</span><span class="na">query</span><span class="p">(</span><span class="s2">&quot;SELECT id FROM users WHERE active = 1&quot;</span><span class="p">);</span>
</span><span class='line'><span class="nv">$users</span> <span class="o">=</span> <span class="nv">$sth</span><span class="o">-&gt;</span><span class="na">fetchAll</span><span class="p">(</span><span class="nx">PDO</span><span class="o">::</span><span class="na">FETCH_COLUMN</span><span class="p">);</span>
</span></code></pre></td></tr></table></div></figure>


<h3>Fetching key value pairs</h3>

<p>Now say you wanted an array of users with the user id as the keys and the user&rsquo;s name as the values.</p>

<figure class='code'><figcaption><span>Using mysql_query</span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
</pre></td><td class='code'><pre><code class='php'><span class='line'><span class="nv">$users</span> <span class="o">=</span> <span class="k">array</span><span class="p">();</span>
</span><span class='line'><span class="nv">$result</span> <span class="o">=</span> <span class="nb">mysql_query</span><span class="p">(</span><span class="s2">&quot;SELECT id, name FROM users&quot;</span><span class="p">,</span> <span class="nv">$link</span><span class="p">);</span>
</span><span class='line'><span class="k">while</span> <span class="p">(</span><span class="nv">$row</span> <span class="o">=</span> <span class="nb">mysql_fetch_assoc</span><span class="p">(</span><span class="nv">$result</span><span class="p">))</span> <span class="p">{</span>
</span><span class='line'>    <span class="nv">$users</span><span class="p">[</span><span class="nv">$row</span><span class="p">[</span><span class="s1">&#39;id&#39;</span><span class="p">]]</span> <span class="o">=</span> <span class="nv">$row</span><span class="p">[</span><span class="s1">&#39;name&#39;</span><span class="p">];</span>
</span><span class='line'><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>




<figure class='code'><figcaption><span>Using PDO</span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class='php'><span class='line'><span class="nv">$sth</span> <span class="o">=</span> <span class="nv">$dbh</span><span class="o">-&gt;</span><span class="na">query</span><span class="p">(</span><span class="s2">&quot;SELECT id, name FROM users&quot;</span><span class="p">);</span>
</span><span class='line'><span class="nv">$users</span> <span class="o">=</span> <span class="nv">$sth</span><span class="o">-&gt;</span><span class="na">fetchAll</span><span class="p">(</span><span class="nx">PDO</span><span class="o">::</span><span class="na">FETCH_KEY_PAIR</span><span class="p">);</span>
</span></code></pre></td></tr></table></div></figure>


<h3>Fetching into a specific class</h3>

<p>Many times you want to populate a class with result from a query.</p>

<p>This is easy with PDO.</p>

<figure class='code'><figcaption><span>Fetching into a class</span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
</pre></td><td class='code'><pre><code class='php'><span class='line'><span class="k">class</span> <span class="nc">User</span>
</span><span class='line'><span class="p">{</span>
</span><span class='line'>    <span class="k">public</span> <span class="nv">$id</span><span class="p">;</span>
</span><span class='line'>    <span class="k">public</span> <span class="nv">$name</span><span class="p">;</span>
</span><span class='line'>    <span class="k">public</span> <span class="nv">$email</span><span class="p">;</span>
</span><span class='line'><span class="p">}</span>
</span><span class='line'>
</span><span class='line'><span class="nv">$sth</span> <span class="o">=</span> <span class="nv">$dbh</span><span class="o">-&gt;</span><span class="na">query</span><span class="p">(</span><span class="s2">&quot;SELECT id, name, email FROM users WHERE id = 1&quot;</span><span class="p">);</span>
</span><span class='line'><span class="nv">$users</span> <span class="o">=</span> <span class="nv">$sth</span><span class="o">-&gt;</span><span class="na">fetch</span><span class="p">(</span><span class="nx">PDO</span><span class="o">::</span><span class="na">FETCH_CLASS</span><span class="p">,</span> <span class="s1">&#39;user&#39;</span><span class="p">);</span>
</span></code></pre></td></tr></table></div></figure>


<p>This isn&rsquo;t that exciting with an example as simple as this but the User class can have other methods in it or validation with the __set() magic method.<br/>
You can also pass it to methods with type hinting to ensure you are getting the correct data.</p>

<h2>Handling Errors</h2>

<p>How you handle errors is an important part of developing an application.<br/>
It cannot be assumed that the database will always be up and every query will succeed.</p>

<p>Without checking if a given query was successful the code will continue running assuming that was query was successful.<br/>
This can lead to further problems with the application.<br/>
For example if you have a user registration form that inserts the user into the database then sends out an activation email it makes no sense to send the email unless the account was created successfully.</p>

<p>A lot of example code in the wild will use the <a href="http://us3.php.net/manual/en/function.die.php">die</a> function to exit the script when a mysql_* function fails printing the database error using the <a href="http://us2.php.net/manual/en/function.mysql-error.php">mysql_error</a> function.<br/>
This is generally not the best way to handle errors.<br/>
Printing the errors to the screen can expose information to the user than can compromise security.</p>

<p>A better idea would be to log any errors that occur and show the user a human readable error message saying something went wrong either by redirecting them to an error page or showing the message on the current page.</p>

<p>For the following examples I&rsquo;m going to assume that you have defined a function names handle_error that accepts an error message and error code.</p>

<figure class='code'><figcaption><span>Error Logger</span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
</pre></td><td class='code'><pre><code class='php'><span class='line'><span class="sd">/**</span>
</span><span class='line'><span class="sd"> * </span>
</span><span class='line'><span class="sd"> * Logs error</span>
</span><span class='line'><span class="sd"> *</span>
</span><span class='line'><span class="sd"> * @param string $message Human friendly error message</span>
</span><span class='line'><span class="sd"> * @param string $error Error message returned from function or method that failed</span>
</span><span class='line'><span class="sd"> * @param int $code Error code from failed function or method</span>
</span><span class='line'><span class="sd"> * @param mixed $extra Any extra data you want to log.</span>
</span><span class='line'><span class="sd"> *</span>
</span><span class='line'><span class="sd"> * @return void</span>
</span><span class='line'><span class="sd"> */</span>
</span><span class='line'><span class="k">function</span> <span class="nf">log_error</span><span class="p">(</span><span class="nv">$message</span><span class="p">,</span> <span class="nv">$error</span> <span class="o">=</span> <span class="k">null</span><span class="p">,</span> <span class="nv">$code</span> <span class="o">=</span> <span class="k">null</span><span class="p">,</span> <span class="nv">$extra</span> <span class="o">=</span> <span class="k">null</span><span class="p">){</span>
</span><span class='line'>    <span class="c1">// This would log the error to an error log</span>
</span><span class='line'>    <span class="c1">// You could use an existing logging library or use a simple fwrite.</span>
</span><span class='line'>    <span class="c1">// For a good logging library I recommend monolog https://github.com/Seldaek/monolog</span>
</span><span class='line'><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<h3>Handling errors with mysql_connect and mysql_query</h3>

<p>In general the mysql_* functions return FALSE when they fail.  After calling one of them you need to check the result to see if it was successful.</p>

<p>The function <a href="http://us2.php.net/manual/en/function.mysql-error.php">mysql_error</a> will return a text error message of the last error that occurred and <a href="http://us2.php.net/manual/en/function.mysql-errno.php">mysql_errno</a> will return a numeric error code.</p>

<figure class='code'><figcaption><span>mysql_connect</span><a href='http://us2.php.net/manual/en/function.mysql-error.php'>docs</a></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
</pre></td><td class='code'><pre><code class='php'><span class='line'><span class="nv">$link</span> <span class="o">=</span> <span class="nb">mysql_connect</span><span class="p">(</span><span class="s1">&#39;localhost&#39;</span><span class="p">,</span> <span class="s1">&#39;user&#39;</span><span class="p">,</span> <span class="s1">&#39;password&#39;</span><span class="p">);</span>
</span><span class='line'><span class="k">if</span> <span class="p">(</span><span class="nv">$link</span> <span class="o">===</span> <span class="k">false</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>    <span class="nx">log_error</span><span class="p">(</span><span class="s2">&quot;Failed to connect to database&quot;</span><span class="p">,</span> <span class="nb">mysql_error</span><span class="p">(),</span> <span class="nb">mysql_errno</span><span class="p">());</span>
</span><span class='line'>    <span class="c1">// This would store the human readable message for the next request</span>
</span><span class='line'>    <span class="nx">flash_message</span><span class="p">(</span><span class="s2">&quot;There was a problem connecting to the database. Please try again later.&quot;</span><span class="p">);</span>
</span><span class='line'>    <span class="c1">// This could redirect to a separate error page or just to itself</span>
</span><span class='line'>    <span class="nx">header</span><span class="p">(</span><span class="s1">&#39;location: error.php&#39;</span><span class="p">);</span>
</span><span class='line'>    <span class="k">exit</span><span class="p">;</span>
</span><span class='line'><span class="p">}</span>
</span><span class='line'><span class="k">if</span> <span class="p">(</span><span class="nb">mysql_select_db</span><span class="p">(</span><span class="s1">&#39;database&#39;</span><span class="p">,</span> <span class="nv">$link</span><span class="p">)</span> <span class="o">===</span> <span class="k">false</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>    <span class="nx">log_error</span><span class="p">(</span><span class="s2">&quot;Failed to select database&quot;</span><span class="p">,</span> <span class="nb">mysql_error</span><span class="p">(),</span> <span class="nb">mysql_errno</span><span class="p">());</span>
</span><span class='line'>    <span class="c1">// This would store the human readable message for the next request</span>
</span><span class='line'>    <span class="nx">flash_message</span><span class="p">(</span><span class="s2">&quot;There was a problem connecting to the database. Please try again later.&quot;</span><span class="p">);</span>
</span><span class='line'>    <span class="c1">// This could redirect to a separate error page or just to itself</span>
</span><span class='line'>    <span class="nx">header</span><span class="p">(</span><span class="s1">&#39;location: error.php&#39;</span><span class="p">);</span>
</span><span class='line'>    <span class="k">exit</span><span class="p">;</span>
</span><span class='line'><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>You can handle errors with queries much the same way.</p>

<figure class='code'><figcaption><span>mysql_query</span><a href='http://us2.php.net/manual/en/function.mysql-error.php'>docs</a></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
</pre></td><td class='code'><pre><code class='php'><span class='line'><span class="nv">$result</span> <span class="o">=</span> <span class="nb">mysql_query</span><span class="p">(</span><span class="s2">&quot;INSERT INTO users (first_name, last_name, email_address) VALUES (&#39;John&#39;, &#39;Doe&#39;, &#39;email@example.com&#39;)&quot;</span><span class="p">,</span> <span class="nv">$link</span><span class="p">);</span>
</span><span class='line'><span class="k">if</span> <span class="p">(</span><span class="nv">$result</span> <span class="o">===</span> <span class="k">false</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>    <span class="nx">log_error</span><span class="p">(</span><span class="s2">&quot;Failed to insert user&quot;</span><span class="p">,</span> <span class="nb">mysql_error</span><span class="p">(),</span> <span class="nb">mysql_errno</span><span class="p">());</span>
</span><span class='line'>    <span class="c1">// This would store the human readable message for the next request</span>
</span><span class='line'>    <span class="nx">flash_message</span><span class="p">(</span><span class="s2">&quot;There was a problem creating your account. Please try again later.&quot;</span><span class="p">);</span>
</span><span class='line'>    <span class="c1">// This could redirect to a separate error page or just to itself</span>
</span><span class='line'>    <span class="nx">header</span><span class="p">(</span><span class="s1">&#39;location: error.php&#39;</span><span class="p">);</span>
</span><span class='line'>    <span class="k">exit</span><span class="p">;</span>
</span><span class='line'><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<h3>Handling errors with PDO</h3>

<p>PDO has multiple ways of <a href="http://us3.php.net/manual/en/pdo.error-handling.php">handling errors</a>.</p>

<p>There are three error modes for PDO.</p>

<p>The first is PDO::ERRMODE_SILENT.<br/>
This acts much like the mysql_* functions in that after calling a PDO method you need to check <a href="http://us3.php.net/manual/en/pdo.errorcode.php">PDO::errorCode</a> or <a href="http://us3.php.net/manual/en/pdo.errorinfo.php">PDO::errorInfo</a> to see if it was successful.</p>

<p>The second error mode is PDO::ERRMODE_WARNING.<br/>
This is much the same except an E_WARNING message is also thrown.</p>

<p>The final error mode is PDO::ERRMODE_EXCEPTION.<br/>
This one throws a <a href="http://us3.php.net/manual/en/class.pdoexception.php">PDOException</a> when an error occurs.
This is the method I recommend and will be using it for further examples.</p>

<figure class='code'><figcaption><span>Setting the Error Mode</span><a href='http://us3.php.net/manual/en/pdo.error-handling.php'>docs</a></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
</pre></td><td class='code'><pre><code class='php'><span class='line'><span class="c1">// You can set the error mode using the fourth options parameter on the constructor</span>
</span><span class='line'><span class="nv">$dbh</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">PDO</span><span class="p">(</span><span class="nv">$dsn</span><span class="p">,</span> <span class="nv">$user</span><span class="p">,</span> <span class="nv">$password</span><span class="p">,</span> <span class="k">array</span><span class="p">(</span><span class="nx">PDO</span><span class="o">::</span><span class="na">ATTR_ERRMODE</span> <span class="o">=&gt;</span> <span class="nx">PDO</span><span class="o">::</span><span class="na">ERRMODE_EXCEPTION</span><span class="p">));</span>
</span><span class='line'>
</span><span class='line'><span class="c1">// or you can use the setAttribute method to set the error mode on an existing connection</span>
</span><span class='line'><span class="nv">$dbh</span><span class="o">-&gt;</span><span class="na">setAttribute</span><span class="p">(</span><span class="nx">PDO</span><span class="o">::</span><span class="na">ATTR_ERRMODE</span><span class="p">,</span> <span class="nx">PDO</span><span class="o">::</span><span class="na">ERRMODE_EXCEPTION</span><span class="p">);</span>
</span></code></pre></td></tr></table></div></figure>




<figure class='code'><figcaption><span>Connect with error handling</span><a href='http://us3.php.net/manual/en/pdo.error-handling.php'>docs</a></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
</pre></td><td class='code'><pre><code class='php'><span class='line'><span class="k">try</span> <span class="p">{</span>
</span><span class='line'>    <span class="nv">$dbh</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">PDO</span><span class="p">(</span><span class="nv">$dsn</span><span class="p">,</span> <span class="nv">$user</span><span class="p">,</span> <span class="nv">$password</span><span class="p">,</span> <span class="k">array</span><span class="p">(</span><span class="nx">PDO</span><span class="o">::</span><span class="na">ATTR_ERRMODE</span> <span class="o">=&gt;</span> <span class="nx">PDO</span><span class="o">::</span><span class="na">ERRMODE_EXCEPTION</span><span class="p">));</span>
</span><span class='line'><span class="p">}</span> <span class="k">catch</span> <span class="p">(</span><span class="nx">PDOException</span> <span class="nv">$e</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>    <span class="nx">log_error</span><span class="p">(</span><span class="s2">&quot;Failed to connect to database&quot;</span><span class="p">,</span> <span class="nv">$e</span><span class="o">-&gt;</span><span class="na">getMessage</span><span class="p">(),</span> <span class="nv">$e</span><span class="o">-&gt;</span><span class="na">getCode</span><span class="p">(),</span> <span class="k">array</span><span class="p">(</span><span class="s1">&#39;exception&#39;</span> <span class="o">=&gt;</span> <span class="nv">$e</span><span class="p">));</span>
</span><span class='line'><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>




<figure class='code'><figcaption><span>Running a query with error handling</span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
</pre></td><td class='code'><pre><code class='php'><span class='line'><span class="k">try</span> <span class="p">{</span>
</span><span class='line'>    <span class="nv">$dbh</span><span class="o">-&gt;</span><span class="na">query</span><span class="p">(</span><span class="s2">&quot;INVALID SQL&quot;</span><span class="p">);</span>
</span><span class='line'><span class="p">}</span> <span class="k">catch</span> <span class="p">(</span><span class="nx">PDOException</span> <span class="nv">$e</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>    <span class="nx">log_error</span><span class="p">(</span><span class="s2">&quot;Failed to run query&quot;</span><span class="p">,</span> <span class="nv">$e</span><span class="o">-&gt;</span><span class="na">getMessage</span><span class="p">(),</span> <span class="nv">$e</span><span class="o">-&gt;</span><span class="na">getCode</span><span class="p">(),</span> <span class="k">array</span><span class="p">(</span><span class="s1">&#39;exception&#39;</span> <span class="o">=&gt;</span> <span class="nv">$e</span><span class="p">));</span>
</span><span class='line'><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<h2>Escaping Data</h2>

<p>Whenever you execute a query that contains any data other than string literals you need to guard yourself against <a href="http://en.wikipedia.org/wiki/SQL_injection">SQL Injection</a>.</p>

<p>All data should be escaped whether it comes from a posted form, another database query, read from a file, or returned from a web service.<br/>
Anything that is not a hard-coded string that you typed yourself cannot be trusted and needs to be escaped.</p>

<h3>Escaping data with the mysql extension</h3>

<p>Escaping data with the mysql extension is done with the <a href="http://php.net/manual/en/function.mysql-real-escape-string.php">mysql_real_escape_string</a> function.</p>

<figure class='code'><figcaption><span>Escaping data with mysql_real_escape_string</span><a href='http://php.net/manual/en/function.mysql-real-escape-string.php'>link</a></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
</pre></td><td class='code'><pre><code class='php'><span class='line'><span class="nv">$query</span> <span class="o">=</span> <span class="nb">sprintf</span><span class="p">(</span><span class="s2">&quot;SELECT * FROM users WHERE username=&#39;%s&#39; AND password=&#39;%s&#39;&quot;</span><span class="p">,</span>
</span><span class='line'>    <span class="nb">mysql_real_escape_string</span><span class="p">(</span><span class="nv">$name</span><span class="p">,</span> <span class="nv">$link</span><span class="p">),</span>
</span><span class='line'>    <span class="nb">mysql_real_escape_string</span><span class="p">(</span><span class="nv">$password</span><span class="p">,</span> <span class="nv">$link</span><span class="p">)</span>
</span><span class='line'><span class="p">);</span>
</span><span class='line'><span class="nv">$result</span> <span class="o">=</span> <span class="nb">mysql_query</span><span class="p">(</span><span class="nv">$query</span><span class="p">,</span> <span class="nv">$link</span><span class="p">);</span>
</span><span class='line'><span class="k">if</span> <span class="p">(</span><span class="nv">$result</span> <span class="o">===</span> <span class="k">false</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>    <span class="nx">log_error</span><span class="p">(</span><span class="s2">&quot;Failed to select user&quot;</span><span class="p">,</span> <span class="nb">mysql_error</span><span class="p">(),</span> <span class="nb">mysql_errno</span><span class="p">());</span>
</span><span class='line'>    <span class="nv">$user</span> <span class="o">=</span> <span class="k">false</span><span class="p">;</span>
</span><span class='line'><span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
</span><span class='line'>    <span class="nv">$user</span> <span class="o">=</span> <span class="nb">mysql_fetch_assoc</span><span class="p">(</span><span class="nv">$result</span><span class="p">)</span>
</span><span class='line'><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<h3>Escaping data with PDO</h3>

<p>PDO has a similar method of escaping data <a href="http://php.net/manual/en/pdo.quote.php">PDO::quote</a>.<br/>
However this isn&rsquo;t the best way of handling passing data to queries with PDO.</p>

<h2>Prepared Statements</h2>

<p>Up until now I haven&rsquo;t covered anything that would provide a real advantage to switching to PDO.
Sure some of the syntax is a little shorter and easier to work with but are just differences in syntax for the same features.</p>

<p>Now I&rsquo;ll get to features that you just cannot do with the plain mysql extension.</p>

<p>Prepared statements work a little differently than just replacing placeholders with escaped strings like you would do with the <a href="http://php.net/manual/en/function.mysql-real-escape-string.php">mysql_real_escape_string</a> function or the <a href="http://php.net/manual/en/pdo.quote.php">PDO::quote</a> method.</p>

<p>With a prepared statement the query is actually sent to the database with the placeholders.
This query is compiled and a statement is returned.
You then send the data over separately and the database does handles all the escaping and replacing for you.
This makes them much safer and less error prone than escaping the data yourself.</p>

<p>With PDO there are two ways of providing parameters for a prepared statement.</p>

<figure class='code'><figcaption><span>Question Mark Parameters</span><a href='http://php.net/manual/en/pdo.prepare.php'>link</a></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
</pre></td><td class='code'><pre><code class='php'><span class='line'><span class="k">try</span> <span class="p">{</span>
</span><span class='line'>    <span class="nv">$sth</span> <span class="o">=</span> <span class="nv">$dbh</span><span class="o">-&gt;</span><span class="na">prepare</span><span class="p">(</span><span class="s2">&quot;SELECT * FROM users WHERE username = ? AND password = ?&quot;</span><span class="p">);</span>
</span><span class='line'>    <span class="nv">$sth</span><span class="o">-&gt;</span><span class="na">execute</span><span class="p">(</span><span class="k">array</span><span class="p">(</span><span class="nv">$username</span><span class="p">,</span> <span class="nv">$password</span><span class="p">));</span>
</span><span class='line'>    <span class="nv">$user</span> <span class="o">=</span> <span class="nv">$sth</span><span class="o">-&gt;</span><span class="na">fetch</span><span class="p">(</span><span class="nx">PDO</span><span class="o">::</span><span class="na">FETCH_ASSOC</span><span class="p">);</span>
</span><span class='line'><span class="p">}</span> <span class="k">catch</span> <span class="p">(</span><span class="nx">PDOException</span> <span class="nv">$e</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>    <span class="nx">log_error</span><span class="p">(</span><span class="s2">&quot;Failed to select user&quot;</span><span class="p">,</span> <span class="nv">$e</span><span class="o">-&gt;</span><span class="na">getMessage</span><span class="p">(),</span> <span class="nv">$e</span><span class="o">-&gt;</span><span class="na">getCode</span><span class="p">(),</span> <span class="k">array</span><span class="p">(</span><span class="s1">&#39;exception&#39;</span> <span class="o">=&gt;</span> <span class="nv">$e</span><span class="p">));</span>
</span><span class='line'><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>




<figure class='code'><figcaption><span>Named Parameters</span><a href='http://php.net/manual/en/pdo.prepare.php'>link</a></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
</pre></td><td class='code'><pre><code class='php'><span class='line'><span class="k">try</span> <span class="p">{</span>
</span><span class='line'>    <span class="nv">$sth</span> <span class="o">=</span> <span class="nv">$dbh</span><span class="o">-&gt;</span><span class="na">prepare</span><span class="p">(</span><span class="s2">&quot;SELECT * FROM users WHERE username = :username AND password = :password&quot;</span><span class="p">);</span>
</span><span class='line'>    <span class="nv">$sth</span><span class="o">-&gt;</span><span class="na">execute</span><span class="p">(</span><span class="k">array</span><span class="p">(</span>
</span><span class='line'>        <span class="s1">&#39;username&#39;</span> <span class="o">=&gt;</span> <span class="nv">$username</span><span class="p">,</span>
</span><span class='line'>        <span class="s1">&#39;password&#39;</span> <span class="o">=&gt;</span> <span class="nv">$password</span>
</span><span class='line'>    <span class="p">));</span>
</span><span class='line'>    <span class="nv">$user</span> <span class="o">=</span> <span class="nv">$sth</span><span class="o">-&gt;</span><span class="na">fetch</span><span class="p">(</span><span class="nx">PDO</span><span class="o">::</span><span class="na">FETCH_ASSOC</span><span class="p">);</span>
</span><span class='line'><span class="p">}</span> <span class="k">catch</span> <span class="p">(</span><span class="nx">PDOException</span> <span class="nv">$e</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>    <span class="nx">log_error</span><span class="p">(</span><span class="s2">&quot;Failed to select user&quot;</span><span class="p">,</span> <span class="nv">$e</span><span class="o">-&gt;</span><span class="na">getMessage</span><span class="p">(),</span> <span class="nv">$e</span><span class="o">-&gt;</span><span class="na">getCode</span><span class="p">(),</span> <span class="k">array</span><span class="p">(</span><span class="s1">&#39;exception&#39;</span> <span class="o">=&gt;</span> <span class="nv">$e</span><span class="p">));</span>
</span><span class='line'><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>Notice that in both of these he values are not surrounded in quotes like with the mysql extension.
Adding quotes will result in a failed query.</p>

<p>I recommend always using a prepared statement if your query involves any data that you would otherwise need to escape.</p>

<h3>Executing a prepared statement multiple times</h3>

<p>Another big advantage to using a prepared statement is when you need to execute a query multiple times with different data, such as inserting multiple records.</p>

<p>You can prepare the query and execute it multiple times.</p>

<figure class='code'><figcaption><span>Multiple Executes</span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
</pre></td><td class='code'><pre><code class='php'><span class='line'><span class="nv">$users</span> <span class="o">=</span> <span class="k">array</span><span class="p">(</span>
</span><span class='line'>  <span class="k">array</span><span class="p">(</span>
</span><span class='line'>    <span class="s1">&#39;name&#39;</span> <span class="o">=&gt;</span> <span class="s1">&#39;Bob&#39;</span><span class="p">,</span>
</span><span class='line'>    <span class="s1">&#39;email&#39;</span> <span class="o">=&gt;</span> <span class="s1">&#39;bob@example.com&#39;</span>
</span><span class='line'>  <span class="p">),</span><span class="k">array</span><span class="p">(</span>
</span><span class='line'>    <span class="s1">&#39;name&#39;</span> <span class="o">=&gt;</span> <span class="s1">&#39;Steve&#39;</span><span class="p">,</span>
</span><span class='line'>    <span class="s1">&#39;email&#39;</span> <span class="o">=&gt;</span> <span class="s1">&#39;steve@example.com&#39;</span>
</span><span class='line'>  <span class="p">),</span><span class="k">array</span><span class="p">(</span>
</span><span class='line'>    <span class="s1">&#39;name&#39;</span> <span class="o">=&gt;</span> <span class="s1">&#39;Carl&#39;</span><span class="p">,</span>
</span><span class='line'>    <span class="s1">&#39;email&#39;</span> <span class="o">=&gt;</span> <span class="s1">&#39;carl@example.com&#39;</span>
</span><span class='line'>  <span class="p">),</span><span class="k">array</span><span class="p">(</span>
</span><span class='line'>    <span class="s1">&#39;name&#39;</span> <span class="o">=&gt;</span> <span class="s1">&#39;John&#39;</span><span class="p">,</span>
</span><span class='line'>    <span class="s1">&#39;email&#39;</span> <span class="o">=&gt;</span> <span class="s1">&#39;john@example.com&#39;</span>
</span><span class='line'>  <span class="p">),</span><span class="k">array</span><span class="p">(</span>
</span><span class='line'>    <span class="s1">&#39;name&#39;</span> <span class="o">=&gt;</span> <span class="s1">&#39;Ken&#39;</span><span class="p">,</span>
</span><span class='line'>    <span class="s1">&#39;email&#39;</span> <span class="o">=&gt;</span> <span class="s1">&#39;ken@example.com&#39;</span>
</span><span class='line'>  <span class="p">)</span>
</span><span class='line'><span class="p">);</span>
</span><span class='line'><span class="nv">$sth</span> <span class="o">=</span> <span class="nv">$dbh</span><span class="o">-&gt;</span><span class="na">prepare</span><span class="p">(</span><span class="s2">&quot;INSERT INTO users (name, email) VALUES (:name, :email)&quot;</span><span class="p">);</span>
</span><span class='line'><span class="k">foreach</span> <span class="p">(</span><span class="nv">$users</span> <span class="k">as</span> <span class="nv">$user</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>    <span class="k">try</span> <span class="p">{</span>
</span><span class='line'>        <span class="nv">$sth</span><span class="o">-&gt;</span><span class="na">execute</span><span class="p">(</span><span class="nv">$user</span><span class="p">);</span>
</span><span class='line'>    <span class="p">}</span> <span class="k">catch</span> <span class="p">(</span><span class="nx">PDOException</span> <span class="nv">$e</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>        <span class="nx">log_error</span><span class="p">(</span><span class="s2">&quot;Failed to insert user&quot;</span><span class="p">,</span> <span class="nv">$e</span><span class="o">-&gt;</span><span class="na">getMessage</span><span class="p">(),</span> <span class="nv">$e</span><span class="o">-&gt;</span><span class="na">getCode</span><span class="p">(),</span> <span class="k">array</span><span class="p">(</span><span class="s1">&#39;exception&#39;</span> <span class="o">=&gt;</span> <span class="nv">$e</span><span class="p">));</span>
</span><span class='line'>    <span class="p">}</span>
</span><span class='line'><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>Because the query is only parsed and compiled by the database once executing a prepared statement multiple times will be much faster than running the full query multiple times.</p>

<h3>Escaping identifiers</h3>

<p>One limitation to parameters in prepared statements is that they can only be used for values.<br/>
You use parameters for things like table or column names.</p>

<p>For example the following will not work.</p>

<figure class='code'><figcaption><span>Invalid Prepared Statement</span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
</pre></td><td class='code'><pre><code class='php'><span class='line'><span class="nv">$column</span> <span class="o">=</span> <span class="nv">$_POST</span><span class="p">[</span><span class="s1">&#39;column&#39;</span><span class="p">];</span>
</span><span class='line'><span class="nv">$value</span> <span class="o">=</span> <span class="nv">$_POST</span><span class="p">[</span><span class="s1">&#39;search&#39;</span><span class="p">];</span>
</span><span class='line'><span class="nv">$sth</span> <span class="o">=</span> <span class="nv">$dbh</span><span class="o">-&gt;</span><span class="na">prepare</span><span class="p">(</span><span class="s2">&quot;SELECT * FROM users where :column = :value&quot;</span><span class="p">);</span>
</span><span class='line'><span class="nv">$sth</span><span class="o">-&gt;</span><span class="na">bindValue</span><span class="p">(</span><span class="s1">&#39;:column&#39;</span><span class="p">,</span> <span class="nv">$column</span><span class="p">);</span>
</span><span class='line'><span class="nv">$sth</span><span class="o">-&gt;</span><span class="na">bindValue</span><span class="p">(</span><span class="s1">&#39;:value&#39;</span><span class="p">,</span> <span class="nv">$value</span><span class="p">);</span>
</span><span class='line'><span class="nv">$sth</span><span class="o">-&gt;</span><span class="na">execute</span><span class="p">();</span>
</span></code></pre></td></tr></table></div></figure>


<p>Since you should know what columns a table has the best way to do something like this is to check the column against a whitelist of accaptible data before passing to your query.</p>

<figure class='code'><figcaption><span>Dynamic Column Names</span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
</pre></td><td class='code'><pre><code class='php'><span class='line'><span class="nv">$column</span> <span class="o">=</span> <span class="nv">$_POST</span><span class="p">[</span><span class="s1">&#39;column&#39;</span><span class="p">];</span>
</span><span class='line'><span class="nv">$value</span> <span class="o">=</span> <span class="nv">$_POST</span><span class="p">[</span><span class="s1">&#39;search&#39;</span><span class="p">];</span>
</span><span class='line'>
</span><span class='line'><span class="nv">$allowed</span> <span class="o">=</span> <span class="k">array</span><span class="p">(</span><span class="s1">&#39;name&#39;</span><span class="p">,</span> <span class="s1">&#39;email&#39;</span><span class="p">);</span>
</span><span class='line'><span class="k">if</span><span class="p">(</span><span class="o">!</span><span class="nb">in_array</span><span class="p">(</span><span class="nv">$column</span><span class="p">,</span> <span class="nv">$allowed</span><span class="p">)){</span>
</span><span class='line'>    <span class="c1">// throw an error and do not execute the query.</span>
</span><span class='line'><span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
</span><span class='line'>    <span class="nv">$sth</span> <span class="o">=</span> <span class="nv">$dbh</span><span class="o">-&gt;</span><span class="na">prepare</span><span class="p">(</span><span class="s2">&quot;SELECT * FROM users where </span><span class="si">$column</span><span class="s2"> = :value&quot;</span><span class="p">);</span>
</span><span class='line'>    <span class="nv">$sth</span><span class="o">-&gt;</span><span class="na">bindValue</span><span class="p">(</span><span class="s1">&#39;:column&#39;</span><span class="p">,</span> <span class="nv">$column</span><span class="p">);</span>
</span><span class='line'>    <span class="nv">$sth</span><span class="o">-&gt;</span><span class="na">bindValue</span><span class="p">(</span><span class="s1">&#39;:value&#39;</span><span class="p">,</span> <span class="nv">$value</span><span class="p">);</span>
</span><span class='line'>    <span class="nv">$sth</span><span class="o">-&gt;</span><span class="na">execute</span><span class="p">();</span>
</span><span class='line'><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<h2>Transactions</h2>

<p>Transactions are another useful feature that isn&rsquo;t available with the mysql extension.</p>

<p>Lets say you have a user table that stores the user&rsquo;s login credentials and you have a user_profile that stores extra profile data for that user with a foreign key to the user table.</p>

<table>
<thead>
<tr>
<th> user </th>
<th> user_profile </th>
</tr>
</thead>
<tbody>
<tr>
<td> user_id </td>
<td> profile_id </td>
</tr>
<tr>
<td> name </td>
<td> user_id </td>
</tr>
<tr>
<td> email </td>
<td> bio </td>
</tr>
<tr>
<td> password </td>
<td> interests </td>
</tr>
</tbody>
</table>


<p>When you add a new user you also want to add the user&rsquo;s profile and then send a welcome email to the user.</p>

<h3>What happens if a query fails?</h3>

<p>If the insert into the user table fails you can throw an error and not try to insert the profile.</p>

<p>But what happens if the insert into the user_profile table fails?<br/>
It could break your application to have a user without a profile.<br/>
Do you try to delete the newly inserted user if the second query fails?</p>

<p>What happens if the welcome email fails?<br/>
What if this email is vital to the application and that if it fails you may as well have never created the account?<br/>
Do you delete both records if it fails?</p>

<p>This is a already messy and could get worse with more tables or other steps.</p>

<p>Fortunately transactions can help with this.</p>

<p>In this example assume the MailSender class throws an exception if the email fails to be sent.</p>

<figure class='code'><figcaption><span>PDO Transaction</span><a href='http://php.net/manual/en/pdo.begintransaction.php'>link</a></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
</pre></td><td class='code'><pre><code class='php'><span class='line'><span class="nv">$dbh</span><span class="o">-&gt;</span><span class="na">setAttribute</span><span class="p">(</span><span class="nx">PDO</span><span class="o">::</span><span class="na">ATTR_ERRMODE</span><span class="p">,</span> <span class="nx">PDO</span><span class="o">::</span><span class="na">ERRMODE_EXCEPTION</span><span class="p">);</span>
</span><span class='line'><span class="nv">$dbh</span><span class="o">-&gt;</span><span class="na">beginTransaction</span><span class="p">();</span>
</span><span class='line'><span class="k">try</span> <span class="p">{</span>
</span><span class='line'>    <span class="nv">$sth</span> <span class="o">=</span> <span class="nv">$dbh</span><span class="o">-&gt;</span><span class="na">prepare</span><span class="p">(</span><span class="s2">&quot;INSERT INTO user (name, email, password) VALUES (?, ?, ?)&quot;</span><span class="p">);</span>
</span><span class='line'>    <span class="nv">$sth</span><span class="o">-&gt;</span><span class="na">execute</span><span class="p">(</span><span class="k">array</span><span class="p">(</span><span class="nv">$name</span><span class="p">,</span> <span class="nv">$email</span><span class="p">,</span> <span class="nv">$password</span><span class="p">));</span>
</span><span class='line'>    <span class="nv">$user_id</span> <span class="o">=</span> <span class="nv">$dbh</span><span class="o">-&gt;</span><span class="na">lastInsertId</span><span class="p">();</span>
</span><span class='line'>    <span class="nv">$sth</span><span class="o">-&gt;</span><span class="na">prepare</span><span class="p">(</span><span class="s2">&quot;INSERT INTO user_profile (user_id, bio, interests) VALUES (?, ?, ?)&quot;</span><span class="p">);</span>
</span><span class='line'>    <span class="nv">$sth</span><span class="o">-&gt;</span><span class="na">execute</span><span class="p">(</span><span class="k">array</span><span class="p">(</span><span class="nv">$user_id</span><span class="p">,</span> <span class="nv">$bio</span><span class="p">,</span> <span class="nv">$interests</span><span class="p">));</span>
</span><span class='line'>    <span class="nv">$mailer</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">MailSender</span><span class="p">();</span>
</span><span class='line'>    <span class="nv">$mailer</span><span class="o">-&gt;</span><span class="na">sendWelcomeEmail</span><span class="p">(</span><span class="nv">$name</span><span class="p">,</span> <span class="nv">$email</span><span class="p">);</span>
</span><span class='line'>    <span class="nv">$dbh</span><span class="o">-&gt;</span><span class="na">commit</span><span class="p">();</span>
</span><span class='line'><span class="p">}</span> <span class="k">catch</span> <span class="p">(</span><span class="nx">Exception</span> <span class="nv">$e</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>    <span class="nv">$dbh</span><span class="o">-&gt;</span><span class="na">rollBack</span><span class="p">();</span>
</span><span class='line'>    <span class="c1">// handle the error</span>
</span><span class='line'><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>If any of the queries fail or the mail sender fails to send the mail the executed queries will be rolled back.</p>

<h2>Conclusion</h2>

<p>I&rsquo;ve only scratched the surface of what PDO can do beyond the basic mysql extension.</p>

<p>Once you&rsquo;ve used it a while and get used to the syntax you&rsquo;ll wonder how you ever lived without it.</p>
]]></content>
  </entry>
  
</feed>
